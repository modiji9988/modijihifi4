
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLASS CLASH - Student vs Teacher PvP</title>
    <style>
        /* Modern with Retro Accents */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a1929 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Subtle CRT Effect for Battles Only */
        .crt-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.15;
            mix-blend-mode: overlay;
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%,
                rgba(0, 0, 0, 0.25) 50%
            );
            background-size: 100% 4px;
            display: none;
        }

        .battle-screen .crt-effect {
            display: block;
        }

        /* Screen Containers - Modern with Scroll */
        .screen {
            display: none;
            width: 100%;
            min-height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            background: transparent;
            overflow-y: auto;
        }

        .active {
            display: block;
        }

        /* Container for content with proper padding */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Home Screen - Modern Gaming Style */
        #home-screen {
            background: linear-gradient(rgba(10, 25, 41, 0.9), rgba(26, 26, 46, 0.9)), 
                        url('https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=1600') center/cover;
        }

        .game-title {
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            background: linear-gradient(45deg, #00d4ff, #0088ff, #ff00cc);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 800;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .game-subtitle {
            font-size: clamp(1rem, 3vw, 1.4rem);
            margin-bottom: 2rem;
            color: #8ab4f8;
            text-align: center;
            font-weight: 300;
        }

        .logo-container {
            width: clamp(120px, 30vw, 200px);
            height: clamp(120px, 30vw, 200px);
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(0, 132, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 212, 255, 0.3);
        }

        .logo {
            font-size: clamp(2rem, 8vw, 3.5rem);
            font-weight: bold;
            background: linear-gradient(45deg, #00d4ff, #0088ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .start-btn {
            background: linear-gradient(135deg, #0066ff 0%, #0088ff 100%);
            color: white;
            border: none;
            padding: 16px 60px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 2rem;
            border-radius: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 
                0 4px 20px rgba(0, 102, 255, 0.4),
                0 0 30px rgba(0, 102, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 25px rgba(0, 102, 255, 0.6),
                0 0 40px rgba(0, 102, 255, 0.3);
            background: linear-gradient(135deg, #0088ff 0%, #00aaff 100%);
        }

        .start-btn:active {
            transform: translateY(0);
        }

        .start-btn::before {
            content: '▶';
            position: absolute;
            left: 20px;
            opacity: 0.8;
        }

        /* Dashboard Screen - Modern Scrollable Layout */
        #dashboard-screen {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .dashboard-title {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            background: linear-gradient(45deg, #00d4ff, #0088ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (min-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 2fr 1fr;
            }
        }

        .dashboard-section {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(100, 116, 139, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .section-title {
            font-size: 1.2rem;
            color: #8ab4f8;
            margin-bottom: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Character Selection - Modern Cards */
        .characters-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 1.5rem;
        }

        .character-card {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .character-card:hover {
            transform: translateY(-5px);
            border-color: #00d4ff;
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.2);
        }

        .character-card.selected {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 136, 255, 0.1));
            border-color: #00d4ff;
            box-shadow: 
                0 10px 25px rgba(0, 212, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .character-card.selected::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #00d4ff;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .character-img {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            margin-bottom: 12px;
            object-fit: cover;
            border: 2px solid rgba(100, 116, 139, 0.5);
            transition: all 0.3s ease;
        }

        .character-card.selected .character-img {
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .character-name {
            font-size: 0.9rem;
            color: #e2e8f0;
            font-weight: 600;
        }

        /* Controls Menu - Modern Accordion */
        .controls-menu {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .controls-menu:hover {
            border-color: #00d4ff;
        }

        .controls-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
            margin-top: 0;
        }

        .controls-content.expanded {
            max-height: 400px;
            margin-top: 20px;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(100, 116, 139, 0.2);
        }

        .control-key {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            padding: 6px 14px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            min-width: 70px;
            text-align: center;
        }

        /* Special Attack Cooldown Display */
        .special-cooldown {
            margin-top: 20px;
            padding: 15px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            text-align: center;
        }

        .cooldown-bar {
            width: 100%;
            height: 12px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 6px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .cooldown-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #00d4ff, #0088ff);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        /* High Scores - Modern List */
        .highscore-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .highscore-list::-webkit-scrollbar {
            width: 6px;
        }

        .highscore-list::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }

        .highscore-list::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 3px;
        }

        .highscore-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 15px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(100, 116, 139, 0.2);
            transition: transform 0.2s ease;
        }

        .highscore-item:hover {
            transform: translateX(5px);
            border-color: #00d4ff;
        }

        .score-rank {
            background: linear-gradient(135deg, #00d4ff, #0088ff);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        /* Selected Display */
        #selected-display {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 136, 255, 0.1));
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            text-align: center;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            justify-content: center;
            width: 100%;
            grid-column: 1 / -1;
            padding-bottom: 40px;
        }

        .action-btn {
            padding: 16px 40px;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            border-radius: 12px;
            min-width: 180px;
        }

        .battle-btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0088ff 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }

        .back-btn {
            background: rgba(100, 116, 139, 0.2);
            color: #cbd5e1;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .battle-btn:hover {
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.6);
            background: linear-gradient(135deg, #0088ff 0%, #00aaff 100%);
        }

        .back-btn:hover {
            background: rgba(100, 116, 139, 0.3);
            border-color: #00d4ff;
        }

        /* Battle Screen - Modern Arena - MOBILE OPTIMIZED */
        #battle-screen {
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            overflow: hidden;
        }

        .battle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1000px;
            margin: 10px auto;
            padding: 15px;
            flex-wrap: wrap;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 45%;
            min-width: 140px;
        }

        .player-name {
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .player-name.student {
            color: #00d4ff;
        }

        .player-name.teacher {
            color: #ff6b9d;
        }

        .health-container {
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            height: 18px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .health-bar {
            height: 100%;
            width: 100%;
            border-radius: 9px;
            transition: width 0.3s ease;
            position: relative;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
        }

        .teacher-health {
            background: linear-gradient(90deg, #ff6b9d, #ff00cc);
        }

        .health-text {
            margin-top: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #cbd5e1;
        }

        .versus {
            font-size: 1.8rem;
            color: #ffd700;
            font-weight: 800;
            width: 10%;
            min-width: 60px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Battle Arena - MOBILE OPTIMIZED */
        .battle-arena {
            width: 100%;
            max-width: 1000px;
            height: clamp(400px, 65vh, 600px);
            background: rgba(10, 10, 15, 0.9);
            position: relative;
            margin: 10px auto;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid rgba(0, 212, 255, 0.3);
            box-shadow: 
                inset 0 0 50px rgba(0, 0, 0, 0.5),
                0 20px 50px rgba(0, 0, 0, 0.3);
        }

        /* Battle Stats - MOBILE OPTIMIZED */
        .battle-stats {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(15, 23, 42, 0.95);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            z-index: 100;
            backdrop-filter: blur(10px);
            min-width: 120px;
            max-width: 150px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            color: #8ab4f8;
            font-size: 0.85rem;
        }

        .stat-value {
            color: #00d4ff;
            font-weight: 700;
            font-size: 1rem;
        }

        /* Special Attack Status - MOBILE OPTIMIZED */
        .special-status {
            position: fixed;
            bottom: 220px; /* Adjusted for mobile controls */
            left: 10px;
            background: rgba(15, 23, 42, 0.95);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            z-index: 100;
            backdrop-filter: blur(10px);
            min-width: 150px;
            max-width: 180px;
        }

        .special-ready {
            color: #00ff88;
            font-weight: 600;
        }

        .special-cooldown-battle {
            color: #ff4444;
            font-weight: 600;
        }

        .cooldown-bar-battle {
            width: 100%;
            height: 10px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .cooldown-fill-battle {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffaa00);
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        /* Teacher Sprite Container */
        .teacher-sprite-container {
            position: absolute;
            z-index: 10;
            pointer-events: none;
            transition: transform 0.1s ease;
        }

        /* Character Squares - MOBILE OPTIMIZED */
        .character-square {
            position: absolute;
            transition: transform 0.1s ease;
            z-index: 10;
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .student-square {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background-size: cover;
            background-position: center;
            box-shadow: 
                0 0 20px rgba(0, 212, 255, 0.6),
                inset 0 0 20px rgba(0, 212, 255, 0.2);
        }

        .teacher-square {
            width: 55px;
            height: 55px;
            border-radius: 16px;
            background-size: cover;
            background-position: center;
            border: 3px solid #ff6b9d;
            box-shadow: 
                0 0 20px rgba(255, 107, 157, 0.6),
                inset 0 0 20px rgba(255, 107, 157, 0.2);
        }

        /* Projectiles */
        .projectile {
            position: absolute;
            z-index: 5;
            pointer-events: none;
            border-radius: 50%;
        }

        .student-projectile {
            width: 10px;
            height: 10px;
            background: #00d4ff;
            box-shadow: 0 0 10px #00d4ff;
        }

        .teacher-projectile {
            width: 10px;
            height: 10px;
            background: #ff6b9d;
            box-shadow: 0 0 10px #ff6b9d;
        }

        .special-projectile {
            width: 16px;
            height: 16px;
            background: #ffd700;
            box-shadow: 0 0 20px #ffd700;
            animation: spin 0.5s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Damage Numbers */
        .damage-text {
            position: absolute;
            color: #ff4444;
            font-weight: 800;
            font-size: 1.1rem;
            z-index: 20;
            pointer-events: none;
            animation: floatUp 1s forwards;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* Teacher Comic Popup */
        .teacher-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            background: linear-gradient(135deg, #1a1a2e 0%, #2d2d4d 100%);
            border-radius: 20px;
            padding: 30px;
            min-width: 300px;
            max-width: 90%;
            z-index: 2000;
            border: 3px solid #ff6b9d;
            box-shadow: 
                0 0 40px rgba(255, 107, 157, 0.8),
                0 10px 30px rgba(0, 0, 0, 0.5);
            opacity: 0;
            animation: popupAppear 0.5s forwards;
            text-align: center;
            display: none;
        }

        @keyframes popupAppear {
            0% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            70% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .teacher-popup-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .teacher-popup-image {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            border: 3px solid #ff6b9d;
            object-fit: cover;
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.6);
        }

        .teacher-popup-name {
            font-size: 1.8rem;
            color: #ff6b9d;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(255, 107, 157, 0.5);
        }

        .teacher-popup-message {
            font-size: 1.4rem;
            color: #ffffff;
            background: rgba(255, 107, 157, 0.2);
            padding: 20px;
            border-radius: 15px;
            border: 2px dashed rgba(255, 107, 157, 0.4);
            margin: 20px 0;
            font-style: italic;
            line-height: 1.4;
            font-weight: 600;
        }

        .teacher-popup-quote {
            font-size: 1rem;
            color: #94a3b8;
            font-style: italic;
            margin-top: 15px;
        }

        .teacher-popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #ff6b9d;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .teacher-popup-close:hover {
            background: rgba(255, 107, 157, 0.2);
            transform: scale(1.1);
        }

        /* Teacher Special Attack Effects */
        .special-attack-effect {
            position: absolute;
            pointer-events: none;
            z-index: 50;
        }

        .demonetization-effect {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #000000, #800000);
            opacity: 0.7;
            animation: demonetizePulse 2s infinite;
        }

        @keyframes demonetizePulse {
            0% { opacity: 0.3; }
            50% { opacity: 0.7; }
            100% { opacity: 0.3; }
        }

        .parent-ghost {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: ghostFloat 3s linear infinite;
            filter: blur(2px);
        }

        @keyframes ghostFloat {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            50% { transform: translateY(-20px) scale(1.1); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 0.8; }
        }

        .attendance-freeze {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0, 100, 255, 0.3);
            backdrop-filter: blur(5px);
            animation: freezePulse 1s infinite;
        }

        @keyframes freezePulse {
            0% { backdrop-filter: blur(5px); }
            50% { backdrop-filter: blur(10px); }
            100% { backdrop-filter: blur(5px); }
        }

        .surprise-test-effect {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #ff0000;
            border-radius: 50%;
            animation: testFlash 0.5s infinite;
        }

        @keyframes testFlash {
            0% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
            100% { opacity: 0.3; transform: scale(1); }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(360deg); opacity: 0; }
        }

        .special-attack-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff6b9d, #ff00cc);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.8rem;
            font-weight: 800;
            text-align: center;
            z-index: 1500;
            box-shadow: 0 0 30px rgba(255, 107, 157, 0.8);
            animation: notificationPulse 0.5s ease-in-out 3;
        }

        @keyframes notificationPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Sound Controls */
        .sound-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.9);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            z-index: 1000;
            display: flex;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .sound-btn {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.3);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .sound-btn:hover {
            background: rgba(0, 212, 255, 0.3);
            transform: scale(1.1);
        }

        /* Next Teacher Spawn */
        .next-teacher-spawn {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spawn-title {
            font-size: 2rem;
            color: #00d4ff;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .spawn-timer {
            font-size: 4rem;
            color: #ffd700;
            font-weight: 800;
            text-align: center;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            font-family: 'Courier New', monospace;
        }

        /* Video Overlay */
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .video-container {
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 600px;
            position: relative;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 107, 157, 0.8);
        }

        .rn-video {
            border: 5px solid #ff6b9d;
        }

        .modi-video {
            border: 5px solid #00d4ff;
        }

        .video-skip {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 107, 157, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            z-index: 10001;
        }

        .modi-skip {
            background: rgba(0, 212, 255, 0.8);
        }

        .video-skip:hover {
            background: rgba(255, 107, 157, 1);
        }

        .modi-skip:hover {
            background: rgba(0, 212, 255, 1);
        }

        /* Victory Screen */
        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .victory-content {
            background: rgba(15, 23, 42, 0.95);
            padding: 50px;
            border-radius: 30px;
            text-align: center;
            max-width: 800px;
            width: 90%;
            border: 5px solid #00d4ff;
            box-shadow: 
                0 0 50px rgba(0, 212, 255, 0.7),
                0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .victory-title {
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            background: linear-gradient(45deg, #00d4ff, #ffd700, #ff6b9d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 2rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .victory-message {
            font-size: 1.5rem;
            color: #8ab4f8;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .victory-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 3rem 0;
        }

        .victory-stat {
            background: rgba(30, 41, 59, 0.8);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .victory-stat-value {
            font-size: 2.5rem;
            color: #ffd700;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .victory-buttons {
            display: flex;
            gap: 20px;
            margin-top: 3rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Modern Mobile Controls - OPTIMIZED FOR MOBILE */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            z-index: 1000;
            pointer-events: none;
            background: linear-gradient(transparent, rgba(10, 25, 41, 0.8));
        }

        .mobile-controls.active {
            display: block;
        }

        .mobile-controls-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            pointer-events: auto;
        }

        /* Left Control Pad - Optimized for Mobile */
        .control-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: 150px;
            height: 150px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 15px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            box-shadow: 
                0 8px 30px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .pad-btn {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 136, 255, 0.15));
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
            color: #00d4ff;
            font-size: 20px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .pad-btn:active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.4), rgba(0, 136, 255, 0.35));
            transform: scale(0.92);
            box-shadow: 
                inset 0 2px 8px rgba(0, 212, 255, 0.4),
                0 0 15px rgba(0, 212, 255, 0.5);
        }

        .pad-center {
            grid-column: 2;
            grid-row: 2;
            background: rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .pad-center:active {
            background: rgba(0, 212, 255, 0.2);
        }

        /* Right Action Buttons - Optimized */
        .action-buttons-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .action-btn-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            line-height: 1.2;
            padding: 5px;
        }

        .fire-btn {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            border: 3px solid rgba(255, 71, 87, 0.5);
            color: white;
            box-shadow: 
                0 6px 20px rgba(255, 71, 87, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .fire-btn:active {
            transform: scale(0.92);
            background: linear-gradient(135deg, #ff3838, #ff1e1e);
            box-shadow: 
                inset 0 2px 8px rgba(255, 71, 87, 0.5),
                0 0 25px rgba(255, 71, 87, 0.7);
        }

        .special-btn {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border: 3px solid rgba(255, 215, 0, 0.5);
            color: #1a1a2e;
            box-shadow: 
                0 6px 20px rgba(255, 215, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .special-btn:active {
            transform: scale(0.92);
            background: linear-gradient(135deg, #ffaa00, #ff9500);
            box-shadow: 
                inset 0 2px 8px rgba(255, 215, 0, 0.5),
                0 0 25px rgba(255, 215, 0, 0.7);
        }

        .special-btn.cooldown {
            background: linear-gradient(135deg, #64748b, #475569);
            border-color: rgba(100, 116, 139, 0.4);
            color: #94a3b8;
            pointer-events: none;
        }

        /* Special Attack Indicator */
        .special-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 24px;
            height: 24px;
            background: #ff4757;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            border: 2px solid rgba(15, 23, 42, 0.95);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Mobile Controls Label */
        .controls-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            color: #00d4ff;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            white-space: nowrap;
            pointer-events: none;
            background: rgba(15, 23, 42, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        /* Results Screen */
        #results-screen {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .result-title {
            font-size: clamp(2rem, 6vw, 3.5rem);
            background: linear-gradient(45deg, #00d4ff, #0088ff, #ff00cc);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .winner-name {
            font-size: clamp(1.5rem, 5vw, 2.8rem);
            color: #ffd700;
            margin: 2rem 0;
            text-align: center;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 3rem 0;
        }

        .stat-box {
            background: rgba(15, 23, 42, 0.8);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            border-color: #00d4ff;
        }

        .stat-value {
            font-size: 2.5rem;
            color: #00d4ff;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .result-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 3rem;
            justify-content: center;
            padding-bottom: 40px;
        }

        .result-btn {
            padding: 16px 40px;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #00d4ff 0%, #0088ff 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .result-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.4);
        }

        /* Scary Text Overlay for RN Video */
        .rn-scary-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            pointer-events: none;
        }

        .scary-text-line {
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 900;
            color: #ff0000;
            text-align: center;
            text-shadow: 
                0 0 20px #ff0000,
                0 0 40px #ff0000,
                0 0 60px #ff0000;
            animation: scaryPulse 2s infinite alternate;
            margin-bottom: 20px;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Impact', 'Arial Black', sans-serif;
        }

        .scary-text-line:nth-child(2) {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: #ff6b9d;
            text-shadow: 
                0 0 15px #ff6b9d,
                0 0 30px #ff6b9d;
            animation-delay: 0.5s;
        }

        @keyframes scaryPulse {
            0% {
                opacity: 0.3;
                transform: scale(0.95);
                text-shadow: 
                    0 0 10px #ff0000,
                    0 0 20px #ff0000;
            }
            100% {
                opacity: 1;
                transform: scale(1.05);
                text-shadow: 
                    0 0 30px #ff0000,
                    0 0 60px #ff0000,
                    0 0 90px #ff0000;
            }
        }

        /* Add a glitch effect for extra scariness */
        .rn-scary-text::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 0, 0, 0.1) 50%,
                transparent 100%
            );
            animation: glitchMove 3s infinite linear;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes glitchMove {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Make video slightly transparent to show text better */
        .rn-video {
            opacity: 0.9;
        }

        /* Responsive Design - MOBILE OPTIMIZED */
        @media (max-width: 768px) {
            .content-container {
                padding: 10px !important;
            }
            
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .characters-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .character-img {
                width: 70px;
                height: 70px;
            }
            
            .battle-header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .player-info {
                width: 100%;
            }
            
            .versus {
                width: 100%;
                order: -1;
                margin-bottom: 5px;
            }
            
            .player-name {
                font-size: 1.1rem;
                margin-bottom: 8px;
            }
            
            .health-container {
                height: 16px;
            }
            
            .health-text {
                font-size: 0.8rem;
                margin-top: 4px;
            }
            
            .battle-arena {
                height: 65vh !important;
                min-height: 400px;
                margin: 5px auto !important;
            }
            
            .student-square {
                width: 60px;
                height: 60px;
            }
            
            .teacher-square {
                width: 48px;
                height: 48px;
            }
            
            .battle-stats {
                top: 70px;
                right: 10px;
                padding: 10px;
                min-width: 100px;
            }
            
            .stat-item {
                font-size: 0.75rem;
                margin-bottom: 4px;
            }
            
            .stat-value {
                font-size: 0.9rem;
            }
            
            .special-status {
                bottom: 200px;
                left: 10px;
                padding: 10px;
                min-width: 130px;
            }
            
            .teacher-popup {
                min-width: 250px;
                padding: 20px;
            }
            
            .teacher-popup-image {
                width: 60px;
                height: 60px;
            }
            
            .teacher-popup-name {
                font-size: 1.4rem;
            }
            
            .teacher-popup-message {
                font-size: 1.1rem;
                padding: 15px;
            }
            
            .mobile-controls {
                display: block;
            }
            
            .action-buttons,
            .result-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .action-btn,
            .result-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .sound-controls {
                bottom: 180px;
                right: 15px;
            }
            
            .control-pad {
                width: 130px;
                height: 130px;
                padding: 12px;
                gap: 8px;
            }
            
            .pad-btn {
                font-size: 18px;
                border-radius: 12px;
            }
            
            .action-btn-circle {
                width: 65px;
                height: 65px;
                font-size: 12px;
            }
            
            .special-indicator {
                width: 20px;
                height: 20px;
                font-size: 10px;
            }
            
            /* Hide desktop quit button on mobile */
            #battle-screen .action-btn.back-btn:not(.mobile-quit) {
                display: none;
            }
            
            /* Mobile quit button */
            .mobile-quit-btn {
                position: fixed !important;
                top: 10px !important;
                left: 10px !important;
                width: auto !important;
                padding: 10px 15px !important;
                font-size: 0.9rem !important;
                background: rgba(255, 71, 87, 0.2) !important;
                border: 1px solid rgba(255, 71, 87, 0.3) !important;
                color: #ff6b9d !important;
                z-index: 100 !important;
                backdrop-filter: blur(10px) !important;
                max-width: none !important;
                border-radius: 10px !important;
            }
            
            .mobile-quit-btn:active {
                background: rgba(255, 71, 87, 0.4) !important;
                transform: scale(0.95) !important;
            }
        }

        @media (max-width: 480px) {
            .content-container {
                padding: 8px !important;
            }
            
            .characters-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .character-card {
                padding: 12px;
            }
            
            .character-img {
                width: 60px;
                height: 60px;
            }
            
            .battle-arena {
                height: 60vh !important;
                min-height: 350px;
            }
            
            .student-square {
                width: 50px;
                height: 50px;
            }
            
            .teacher-square {
                width: 40px;
                height: 40px;
            }
            
            .teacher-popup {
                min-width: 200px;
                padding: 15px;
            }
            
            .teacher-popup-message {
                font-size: 1rem;
                padding: 12px;
            }
            
            .control-pad {
                width: 120px;
                height: 120px;
                padding: 10px;
                gap: 6px;
            }
            
            .pad-btn {
                font-size: 16px;
                border-radius: 10px;
            }
            
            .action-btn-circle {
                width: 60px;
                height: 60px;
                font-size: 11px;
            }
            
            .mobile-controls {
                padding: 12px;
            }
            
            .controls-label {
                font-size: 8px;
                padding: 1px 4px;
            }
        }

        @media (max-height: 700px) {
            .battle-arena {
                height: 55vh !important;
                min-height: 300px;
            }
            
            .mobile-controls {
                padding: 10px;
            }
            
            .control-pad {
                width: 110px;
                height: 110px;
            }
            
            .action-btn-circle {
                width: 55px;
                height: 55px;
                font-size: 10px;
            }
            
            .special-status {
                bottom: 160px;
            }
        }

        @media (max-height: 600px) {
            .battle-arena {
                height: 50vh !important;
                min-height: 250px;
            }
            
            .mobile-controls {
                padding: 8px;
            }
            
            .control-pad {
                width: 100px;
                height: 100px;
            }
            
            .pad-btn {
                font-size: 14px;
            }
            
            .action-btn-circle {
                width: 50px;
                height: 50px;
                font-size: 9px;
            }
            
            .special-status {
                bottom: 140px;
                padding: 6px;
                font-size: 0.9rem;
            }
        }

        /* Landscape Mode Optimization */
        @media (orientation: landscape) and (max-height: 500px) {
            .battle-arena {
                height: 75vh !important;
                margin: 5px auto;
            }
            
            .mobile-controls {
                padding: 8px 15px;
            }
            
            .mobile-controls-container {
                align-items: center;
            }
            
            .control-pad {
                width: 100px;
                height: 100px;
                padding: 10px;
            }
            
            .action-buttons-right {
                flex-direction: row;
                gap: 20px;
                margin-bottom: 0;
            }
            
            .special-status {
                bottom: 120px;
            }
            
            .battle-stats {
                top: 10px;
                right: 10px;
            }
        }

        /* Prevent default touch behaviors */
        .pad-btn, .action-btn-circle {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        /* Smooth animations */
        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.92); }
            100% { transform: scale(1); }
        }

        .pad-btn:active, .action-btn-circle:active {
            animation: buttonPress 0.2s ease-out;
        }
    </style>
</head>
<body>
    <!-- CRT Effect (Battle Only) -->
    <div class="crt-effect"></div>
    
    <!-- Teacher Comic Popup -->
    <div id="teacher-popup" class="teacher-popup" style="display: none;">
        <button class="teacher-popup-close" onclick="closeTeacherPopup()">×</button>
        <div class="teacher-popup-header">
            <img id="popup-teacher-image" class="teacher-popup-image" src="" alt="">
            <div>
                <div id="popup-teacher-name" class="teacher-popup-name">TEACHER</div>
                <div class="teacher-popup-quote">New Challenger Approaches!</div>
            </div>
        </div>
        <div id="popup-teacher-message" class="teacher-popup-message">
            Loading message...
        </div>
        <div style="color: #94a3b8; font-size: 0.9rem; margin-top: 10px;">
            (Click anywhere or press any key to continue)
        </div>
    </div>
    
    <!-- Modi Video Overlay -->
    <div id="modi-video-overlay" class="video-overlay">
        <div class="video-container">
            <video id="modi-video" class="video-player modi-video">
                <source src="ModiVideo.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <button class="video-skip modi-skip" onclick="skipModiVideo()">SKIP (3)</button>
        </div>
    </div>
    
    <!-- RN Video Overlay -->
    <div id="rn-video-overlay" class="video-overlay">
        <div class="video-container">
            <div id="rn-scary-text" class="rn-scary-text" style="display: none;">
                <div class="scary-text-line">HE IS COMING...</div>
                <div class="scary-text-line">THE OG APPROACHES</div>
            </div>
            <video id="rn-video" class="video-player rn-video">
                <source src="RNVideo.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <button class="video-skip" onclick="skipRNVideo()">SKIP (3)</button>
        </div>
    </div>
    
    <!-- Victory Screen -->
    <div id="victory-screen" class="victory-screen">
        <div class="victory-content">
            <h1 class="victory-title">VICTORY!</h1>
            <div class="victory-message">
                You've defeated all the teachers!<br>
                The classroom is yours!
            </div>
            
            <div class="victory-stats">
                <div class="victory-stat">
                    <div class="victory-stat-value" id="victory-teachers">5</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">TEACHERS DEFEATED</div>
                </div>
                
                <div class="victory-stat">
                    <div class="victory-stat-value" id="victory-score">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">TOTAL SCORE</div>
                </div>
                
                <div class="victory-stat">
                    <div class="victory-stat-value" id="victory-time">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">SECONDS</div>
                </div>
            </div>
            
            <div class="victory-buttons">
                <button class="result-btn" onclick="playAgain()">PLAY AGAIN</button>
                <button class="result-btn" onclick="showScreen('dashboard-screen')">NEW GAME</button>
                <button class="result-btn" onclick="showScreen('home-screen')" style="background: linear-gradient(135deg, #64748b, #475569);">MAIN MENU</button>
            </div>
        </div>
    </div>
    
    <!-- Sound Controls -->
    <div class="sound-controls">
        <button class="sound-btn" onclick="toggleSound()" id="sound-btn">🔊</button>
        <button class="sound-btn" onclick="toggleMusic()" id="music-btn">🎵</button>
    </div>
    
    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
        <div class="content-container">
            <h1 class="game-title">CLASS CLASH</h1>
            <p class="game-subtitle">STUDENT VS TEACHER PvP ARENA</p>
            
            <div class="logo-container">
                <div class="logo">VS</div>
            </div>
            
            <div style="max-width: 600px; margin: 2rem auto; text-align: center;">
                <p style="font-size: 1.1rem; line-height: 1.6; color: #94a3b8; margin-bottom: 1.5rem;">
                    Choose your student warrior and battle waves of teachers in this fast-paced PvP arena!
                    Survive as long as possible and climb the leaderboards.
                </p>
            </div>
            
            <div style="text-align: center;">
                <button class="start-btn" onclick="showScreen('dashboard-screen')">
                    START GAME
                </button>
            </div>
            
            <div style="margin-top: 3rem; text-align: center;">
                <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; color: #00d4ff; font-weight: 700;">16</div>
                        <div style="font-size: 0.9rem; color: #94a3b8;">STUDENTS</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; color: #ff6b9d; font-weight: 700;">5</div>
                        <div style="font-size: 0.9rem; color: #94a3b8;">TEACHERS</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; color: #ffd700; font-weight: 700;">∞</div>
                        <div style="font-size: 0.9rem; color: #94a3b8;">WAVES</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Screen -->
    <div id="dashboard-screen" class="screen">
        <div class="content-container">
            <h1 class="dashboard-title">CHARACTER SELECTION</h1>
            
            <div class="dashboard-container">
                <!-- Character Selection -->
                <div class="dashboard-section">
                    <h2 class="section-title">Student Warriors</h2>
                    <p style="margin-bottom: 1.5rem; color: #94a3b8; font-size: 1rem;">Select your student champion for battle</p>
                    
                    <div class="characters-container" id="student-characters">
                        <!-- Students loaded by JavaScript -->
                    </div>
                    
                    <h2 class="section-title" style="margin-top: 2rem;">Teacher Opponents</h2>
                    <p style="margin-bottom: 1.5rem; color: #94a3b8; font-size: 1rem;">Each teacher appears only once</p>
                    
                    <div class="characters-container" id="teacher-characters">
                        <!-- Teachers loaded by JavaScript -->
                    </div>
                </div>
                
                <!-- Controls & High Scores -->
                <div class="dashboard-section">
                    <h2 class="section-title">Game Controls</h2>
                    
                    <div class="controls-menu" id="controls-menu" onclick="toggleControls()">
                        <div class="controls-menu-header">
                            <h3 style="color: #00d4ff; margin: 0; font-size: 1rem;">Control Panel</h3>
                            <span style="color: #00d4ff; font-size: 1.2rem;" id="controls-arrow">▼</span>
                        </div>
                        <div class="controls-content" id="controls-content">
                            <div class="control-item">
                                <span style="color: #cbd5e1;">Movement</span>
                                <span class="control-key">WASD</span>
                            </div>
                            <div class="control-item">
                                <span style="color: #cbd5e1;">Fire Projectile</span>
                                <span class="control-key">SPACE</span>
                            </div>
                            <div class="control-item">
                                <span style="color: #cbd5e1;">Special Attack</span>
                                <span class="control-key">SHIFT</span>
                            </div>
                            <div class="control-item">
                                <span style="color: #cbd5e1;">Pause Game</span>
                                <span class="control-key">ESC</span>
                            </div>
                            <div class="special-cooldown">
                                <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 8px;">Special Attack Cooldown</div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #00d4ff; font-size: 0.9rem;">Ready</span>
                                    <span style="color: #94a3b8; font-size: 0.9rem;" id="cooldown-time">5s</span>
                                </div>
                                <div class="cooldown-bar">
                                    <div class="cooldown-fill" id="cooldown-fill" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h2 class="section-title" style="margin-top: 2rem;">Leaderboard</h2>
                    <ul class="highscore-list" id="highscore-list">
                        <!-- High scores loaded by JavaScript -->
                    </ul>
                    
                    <div id="selected-display" style="margin-top: 2rem;">
                        <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 8px;">Currently Selected</p>
                        <p style="color: #00d4ff; font-size: 1.1rem; font-weight: 600;" id="selected-text">No student selected</p>
                        <p style="color: #64748b; font-size: 0.8rem; margin-top: 5px;">Click on a student to select</p>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn back-btn" onclick="showScreen('home-screen')">
                    BACK TO MENU
                </button>
                <button class="action-btn battle-btn" onclick="startBattle()">
                    START BATTLE
                </button>
            </div>
        </div>
    </div>
    
    <!-- Battle Screen -->
    <div id="battle-screen" class="screen">
        <div class="content-container">
            <div class="battle-header">
                <div class="player-info">
                    <div class="player-name student" id="student-name">STUDENT</div>
                    <div class="health-container">
                        <div class="health-bar" id="student-health-bar" style="width: 100%"></div>
                    </div>
                    <div class="health-text" id="student-health-text">100/100</div>
                </div>
                
                <div class="versus">VS</div>
                
                <div class="player-info">
                    <div class="player-name teacher" id="teacher-name">TEACHER</div>
                    <div class="health-container">
                        <div class="health-bar teacher-health" id="teacher-health-bar" style="width: 100%"></div>
                    </div>
                    <div class="health-text" id="teacher-health-text">100/100</div>
                </div>
            </div>
            
            <!-- Battle Stats -->
            <div class="battle-stats">
                <div class="stat-item">
                    <span>Round:</span>
                    <span class="stat-value" id="round-count">1</span>
                </div>
                <div class="stat-item">
                    <span>Defeated:</span>
                    <span class="stat-value" id="teachers-defeated">0</span>
                </div>
                <div class="stat-item">
                    <span>Score:</span>
                    <span class="stat-value" id="current-score">0</span>
                </div>
            </div>
            
            <!-- Special Attack Status -->
            <div class="special-status" id="special-status">
                <div id="special-text" class="special-ready">Special Ready</div>
                <div class="cooldown-bar-battle">
                    <div class="cooldown-fill-battle" id="special-cooldown-bar" style="width: 100%"></div>
                </div>
            </div>
            
            <!-- Battle Arena -->
            <div class="battle-arena" id="battle-arena">
                <!-- Characters will be positioned here -->
            </div>
            
            <!-- Next Teacher Spawn -->
            <div class="next-teacher-spawn" id="next-teacher-spawn">
                <div class="spawn-title">NEXT CHALLENGER</div>
                <div class="spawn-timer" id="spawn-timer">3</div>
            </div>
            
            <!-- Modern Mobile Controls -->
            <div class="mobile-controls" id="mobile-controls">
                <div class="mobile-controls-container">
                    <!-- Left Control Pad -->
                    <div class="control-pad" id="control-pad">
                        <div class="pad-btn" 
                             ontouchstart="moveStudent('up-left')" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()"
                             style="grid-column: 1; grid-row: 1;">
                            ↖
                        </div>
                        <div class="pad-btn" 
                             ontouchstart="moveStudent('up')" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()"
                             style="grid-column: 2; grid-row: 1;">
                            ↑
                        </div>
                        <div class="pad-btn" 
                             ontouchstart="moveStudent('up-right')" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()"
                             style="grid-column: 3; grid-row: 1;">
                            ↗
                        </div>
                        <div class="pad-btn" 
                             ontouchstart="moveStudent('left')" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()"
                             style="grid-column: 1; grid-row: 2;">
                            ←
                        </div>
                        <div class="pad-center pad-btn" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()">
                            ●
                        </div>
                        <div class="pad-btn" 
                             ontouchstart="moveStudent('right')" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()"
                             style="grid-column: 3; grid-row: 2;">
                            →
                        </div>
                        <div class="pad-btn" 
                             ontouchstart="moveStudent('down-left')" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()"
                             style="grid-column: 1; grid-row: 3;">
                            ↙
                        </div>
                        <div class="pad-btn" 
                             ontouchstart="moveStudent('down')" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()"
                             style="grid-column: 2; grid-row: 3;">
                            ↓
                        </div>
                        <div class="pad-btn" 
                             ontouchstart="moveStudent('down-right')" 
                             ontouchend="stopMoveStudent()"
                             ontouchcancel="stopMoveStudent()"
                             style="grid-column: 3; grid-row: 3;">
                            ↘
                        </div>
                    </div>
                    
                    <!-- Right Action Buttons -->
                    <div class="action-buttons-right">
                        <div class="action-btn-circle fire-btn" 
                             ontouchstart="shootProjectile()"
                             ontouchend=""
                             ontouchcancel="">
                            FIRE
                            <div class="controls-label">RAPID FIRE</div>
                        </div>
                        <div class="action-btn-circle special-btn" 
                             id="mobile-special-btn"
                             ontouchstart="mobileSpecialAttack()"
                             ontouchend=""
                             ontouchcancel="">
                            SPECIAL
                            <div id="mobile-special-indicator" class="special-indicator" style="display: none;">!</div>
                            <div class="controls-label" id="mobile-special-label">READY</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Quit Button -->
            <button class="action-btn back-btn mobile-quit-btn" onclick="showScreen('dashboard-screen')">
                QUIT
            </button>
            
            <!-- Desktop Quit Button (Hidden on Mobile) -->
            <div style="text-align: center; margin-top: 30px; display: none;">
                <button class="action-btn back-btn" onclick="showScreen('dashboard-screen')" style="max-width: 200px;">
                    QUIT BATTLE
                </button>
            </div>
        </div>
    </div>
    
    <!-- Results Screen -->
    <div id="results-screen" class="screen">
        <div class="content-container">
            <h1 class="result-title" id="result-title">GAME OVER</h1>
            
            <div style="font-size: 1.2rem; color: #94a3b8; margin-bottom: 1rem; text-align: center;">
                <span id="winner-text">STUDENT WINS</span>
            </div>
            
            <div class="winner-name" id="winner-name">ANIK</div>
            
            <div class="result-stats">
                <div class="stat-box">
                    <div class="stat-value" id="teachers-defeated-result">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">TEACHERS DEFEATED</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-value" id="total-score">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">TOTAL SCORE</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-value" id="battle-time">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">SECONDS</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-value" id="round-result">1</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">ROUND REACHED</div>
                </div>
            </div>
            
            <div style="max-width: 500px; margin: 2rem auto; padding: 20px; background: rgba(15, 23, 42, 0.8); border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.3);">
                <h3 style="color: #00d4ff; margin-bottom: 1rem; font-size: 1rem; text-align: center;">BATTLE REPORT</h3>
                <p id="battle-summary" style="color: #94a3b8; line-height: 1.5; font-size: 0.9rem; text-align: center;">
                    Battle complete. Great effort!
                </p>
            </div>
            
            <div class="result-buttons">
                <button class="result-btn rematch-btn" onclick="rematch()">
                    PLAY AGAIN
                </button>
                <button class="result-btn dashboard-result-btn" onclick="showScreen('dashboard-screen')">
                    NEW GAME
                </button>
                <button class="result-btn" onclick="showScreen('home-screen')" style="background: linear-gradient(135deg, #64748b, #475569);">
                    MAIN MENU
                </button>
            </div>
        </div>
    </div>

    <script>
    // Game Data with Teacher Messages and Special Attacks
    const gameData = {
        students: [
            { id: 1, name: "ANIK", image: "https://i.postimg.cc/TPB0TWRV/Anik-Avatar.png", health: 100 },
            { id: 2, name: "ANUBHAV", image: "https://i.postimg.cc/K82xbR32/Anubhav-Avatar.png", health: 100 },
            { id: 3, name: "AYUSH", image: "https://i.postimg.cc/JzLM8GHr/Ayush-Avatar.png", health: 100 },
            { id: 4, name: "HARSHEEL", image: "https://i.postimg.cc/nc6hYFcW/Harsheel-Avatar.png", health: 100 },
            { id: 5, name: "HIMANSHU", image: "https://i.postimg.cc/zGr8NVHJ/Himanshu-Avatar.png", health: 100 },
            { id: 6, name: "MAYANK", image: "https://i.postimg.cc/Gt5RJV82/Mayankesh-Avatar.png", health: 100 },
            { id: 7, name: "PARTH", image: "https://i.postimg.cc/s2bm3ZVn/Parth-Avatar.png", health: 100 },
            { id: 8, name: "PIYUSH", image: "https://i.postimg.cc/GmCdRHTb/Piyush-Avatar.png", health: 100 },
            { id: 9, name: "PRANSHU", image: "https://i.postimg.cc/CK97wfFP/Pranshu-Avatar.png", health: 100 },
            { id: 10, name: "PREET", image: "https://i.postimg.cc/T36fxp52/Preet-Avatar.png", health: 100 },
            { id: 11, name: "RISHIKESH", image: "https://i.postimg.cc/GmxrmdvR/Rishikesh-Avatar.png", health: 100 },
            { id: 12, name: "RITESH", image: "https://i.postimg.cc/13QsSfVz/Ritesh-Avatar.png", health: 100 },
            { id: 13, name: "RUDRA", image: "https://i.postimg.cc/7Lj9qTxt/Rudra-Avatar.png", health: 100 },
            { id: 14, name: "SARTHAK", image: "https://i.postimg.cc/V6MRvL6g/Sarthak-Avatar.png", health: 100 },
            { id: 15, name: "SID", image: "https://i.postimg.cc/DwPFwn1K/Sid-Avatar.png", health: 100 },
            { id: 16, name: "TAMMO", image: "https://i.postimg.cc/1t6HX5tJ/Tammo-Avatar.png", health: 100 }
        ],
        
        // SREELEKHA (id: 2) will be first, MODI (id: 1) second, RN (id: 3) third
        teachers: [
            { 
                id: 1, 
                name: "MODI", 
                image: "https://cdnbbsr.s3waas.gov.in/s3kv02013b3a11c006ef10c7a42ff6a61d/uploads/bfi_thumb/2025060327-r6rcu4tcow2792mxfyhpiqsdvhwx3404m54ulstj68.jpg", 
                health: 100,
                message: "Most IMP. Modi hai toh mumkin hai!",
                quote: "The Prime Teacher",
                specialAttack: "demonetization",
                specialCooldown: 15000,
                lastSpecial: 0,
                useSprite: true,
                sprite: {
                    duck: "https://i.postimg.cc/zGW4btYJ/duck.png",
                    front: "https://i.postimg.cc/Hk5FcZ1j/front.png",
                    hit: "https://i.postimg.cc/2SvgbcN6/hit.png",
                    idle: "https://i.postimg.cc/6pRF2jxp/idle.png",
                    jump: "https://i.postimg.cc/t4P8ZSGg/jump.png",
                    walkA: "https://i.postimg.cc/RZf26sxJ/walk-a.png",
                    walkB: "https://i.postimg.cc/RZf26sxJ/walk-a.png", // Using walk-a for both
                    width: 80,
                    height: 80,
                    scale: 1.5,
                    currentSprite: 'idle',
                    walkFrame: 0,
                    walkTimer: 0,
                    walkSpeed: 300
                },
                hasVideo: true,
                videoFile: "ModiVideo.mp4"
            },
            { 
                id: 2, 
                name: "SREELEKHA", 
                image: "https://cdnbbsr.s3waas.gov.in/s3kv02013b3a11c006ef10c7a42ff6a61d/uploads/bfi_thumb/2025010794-qzna93shqidolax0h8t6k8jrq043flyqiykdecc4nq.jpg", 
                health: 100,
                message: "Hey you! Stand up!",
                quote: "The Disciplinarian",
                specialAttack: "attendance",
                specialCooldown: 12000,
                lastSpecial: 0,
                useSprite: true,
                sprite: {
                    duck: "https://i.postimg.cc/VNdMZMGP/duck.png",
                    front: "https://i.postimg.cc/GpHYgY7t/front.png",
                    hit: "https://i.postimg.cc/HLV5v5ZL/hit.png",
                    idle: "https://i.postimg.cc/zfVW2WtB/idle.png",
                    jump: "https://i.postimg.cc/6QgZk3gN/jump.png",
                    walkA: "https://i.postimg.cc/fbpdGLpM/walk-a.png",
                    walkB: "https://i.postimg.cc/7LdzF6dx/walk-b.png",
                    width: 80,
                    height: 80,
                    scale: 1.5,
                    currentSprite: 'idle',
                    walkFrame: 0,
                    walkTimer: 0,
                    walkSpeed: 300
                }
            },
            { 
                id: 3, 
                name: "RN", 
                image: "https://cdnbbsr.s3waas.gov.in/s3kv02013b3a11c006ef10c7a42ff6a61d/uploads/bfi_thumb/2024111148-e1731362737713-qwx4nhtuky0i39z196vfw50rfg38jumphujxu7akqg.jpg", 
                health: 100,
                message: "Beta tumhare parents bulaayenge!",
                quote: "The Principal",
                specialAttack: "parentMeeting",
                specialCooldown: 20000,
                lastSpecial: 0,
                useSprite: true,
                sprite: {
                    front: "https://i.postimg.cc/ySN1ck6y/front.png",
                    duck: "https://i.postimg.cc/yYvRyv1Y/duck.png",
                    hit: "https://i.postimg.cc/SxRMTCRz/hit.png",
                    idle: "https://i.postimg.cc/y8xZQcxg/idle.png",
                    jump: "https://i.postimg.cc/fRy92myS/jump.png",
                    walkA: "https://i.postimg.cc/cLCn9wCB/walk-a.png",
                    walkB: "https://i.postimg.cc/6pqvjnqh/walk-b.png",
                    width: 80,
                    height: 80,
                    scale: 1.5,
                    currentSprite: 'idle',
                    walkFrame: 0,
                    walkTimer: 0,
                    walkSpeed: 300
                },
                hasVideo: true,
                videoFile: "RNVideo.mp4",
                hasScaryText: true
            },
            { 
                id: 4, 
                name: "ANUJ", 
                image: "https://cdnbbsr.s3waas.gov.in/s3kv02013b3a11c006ef10c7a42ff6a61d/uploads/bfi_thumb/2024111430-qx1c1ll9iusns9e4h1118too8d7vcf61hd0bzydat2.jpg", 
                health: 100,
                message: "Beta masti mat karo RN sir ko bol dunga!",
                quote: "The Monitor",
                specialAttack: "surpriseTest",
                specialCooldown: 10000,
                lastSpecial: 0,
                useSprite: true,
                sprite: {
                    duck: "https://i.postimg.cc/2SvNQXmp/duck.png",
                    front: "https://i.postimg.cc/T3mvVHGx/front.png",
                    hit: "https://i.postimg.cc/nh7f4wZp/hit.png",
                    idle: "https://i.postimg.cc/P5ZnWFhh/idle.png",
                    jump: "https://i.postimg.cc/4xtR6FZX/jump.png",
                    walkA: "https://i.postimg.cc/GmYnFSrh/walk-a.png",
                    walkB: "https://i.postimg.cc/8zWgRnDk/walk-b.png",
                    width: 80,
                    height: 80,
                    scale: 1.5,
                    currentSprite: 'idle',
                    walkFrame: 0,
                    walkTimer: 0,
                    walkSpeed: 300
                }
            },
            { 
                id: 5, 
                name: "PUNIT", 
                image: "https://cdnbbsr.s3waas.gov.in/s3kv02013b3a11c006ef10c7a42ff6a61d/uploads/bfi_thumb/2024111466-qx1c1uznf75j0d0gy53axrba67xjhe7cunj6spzd2u.jpg", 
                health: 100,
                message: "It's a hap-hap-happy b'day!",
                quote: "The Fun Teacher",
                specialAttack: "birthdayParty",
                specialCooldown: 18000,
                lastSpecial: 0,
                useSprite: true,
                sprite: {
                    duck: "https://i.postimg.cc/RVGWrRDQ/duck.png",
                    front: "https://i.postimg.cc/zGBVqgsg/front.png",
                    hit: "https://i.postimg.cc/RVGWrRDQ/duck.png", // Using duck as hit
                    idle: "https://i.postimg.cc/5206fChv/idle.png",
                    jump: "https://i.postimg.cc/zGBVqgsh/jump.png",
                    walkA: "https://i.postimg.cc/t4TY9xKz/walk-a.png",
                    walkB: "https://i.postimg.cc/t4TY9xK5/walk-b.png",
                    width: 80,
                    height: 80,
                    scale: 1.5,
                    currentSprite: 'idle',
                    walkFrame: 0,
                    walkTimer: 0,
                    walkSpeed: 300
                }
            }
        ],
        
        highScores: [
            { name: "ANIK", score: 18500, teachersDefeated: 15, round: 16 },
            { name: "PARTH", score: 14200, teachersDefeated: 12, round: 13 },
            { name: "HARSHEEL", score: 12500, teachersDefeated: 11, round: 12 },
            { name: "SARTHAK", score: 9500, teachersDefeated: 8, round: 9 },
            { name: "TAMMO", score: 7200, teachersDefeated: 6, round: 7 }
        ],
        
        selectedStudent: null,
        currentTeacher: null,
        remainingTeachers: [], // Will hold teachers that haven't been fought yet
        teacherOrder: [], // Will define the order teachers appear
        sreelekhaIndex: 0, // SREELEKHA should be first
        modiIndex: 1, // MODI should be second
        rnIndex: 2, // RN should be third
        
        // Enhanced Sound system
        sounds: {
            enabled: true,
            musicEnabled: true,
            audioContext: null,
            audioElements: {},
            // Track which sounds have been played to avoid duplicates
            playedSounds: new Set(),
            // Track currently playing sounds with priority
            currentlyPlaying: new Set(),
            // Priority levels: 0 = normal, 1 = important, 2 = critical (RNintro)
            soundPriority: {
                'RNintro': 2,
                'ModiIntro': 2,
                'GTA 5 Wasted': 1,
                'Inception': 1,
                'Heavenly Sound': 1,
                'Main Audio': 0,
                'Alert': 0,
                'Burp': 0,
                'Crickets': 0,
                'Crowd Laughing': 0,
                'Goat Scream': 0,
                'No God Please No': 0,
                'Oh No No No': 0,
                'Ohhhhhhhhhh': 0,
                'Rubber Duck': 0,
                'Taco Bell': 0,
                'Wow': 0
            }
        },
        
        battle: {
            studentHealth: 100,
            teacherHealth: 100,
            gameActive: false,
            startTime: null,
            totalScore: 0,
            teachersDefeated: 0,
            currentRound: 1,
            studentPosition: { x: 50, y: 150 },
            teacherPosition: { x: 300, y: 150 },
            keysPressed: {},
            projectiles: [],
            isSpawning: false,
            moveDirection: null,
            specialAttackReady: true,
            specialCooldown: 0,
            specialMaxCooldown: 5000,
            specialCooldownInterval: null,
            showPopup: false,
            activeEffects: [],
            teacherSpecialReady: true,
            lastUpdate: Date.now(),
            // Sprite tracking
            teacherSpriteImages: {},
            teacherWalking: false,
            teacherLastWalkUpdate: 0,
            // Video tracking
            playingVideo: false,
            videoType: null, // 'modi' or 'rn'
            videoSkipTimer: null,
            videoSkipSeconds: 3,
            skipButton: null
        }
    };

    // Sound library URLs - Local files
    const soundLibrary = {
        'Alert': 'Alert.mp3',
        'Burp': 'Burp.mp3',
        'Crickets': 'Crickets.mp3',
        'Crowd Laughing': 'Crowd Laughing.mp3',
        'Goat Scream': 'Goat Scream.mp3',
        'GTA 5 Wasted': 'GTA 5 Wasted.mp3',
        'Heavenly Sound': 'Heavenly Sound.mp3',
        'Inception': 'Inception.mp3',
        'Main Audio': 'Main Audio.mp3',
        'No God Please No': 'No God Please No.mp3',
        'Oh No No No': 'Oh No No No.mp3',
        'Ohhhhhhhhhh': 'Ohhhhhhhhhh.mp3',
        'Rubber Duck': 'Rubber Duck.mp3',
        'Taco Bell': 'Taco Bell.mp3',
        'Wow': 'Wow.mp3',
        'RNintro': 'RNintro.mp3',
        'ModiIntro': 'ModiIntro.mp3'
    };

    // Initialize game
    document.addEventListener('DOMContentLoaded', function() {
        loadStudents();
        loadTeachers();
        loadHighScores();
        
        // Initialize audio
        initAudio();
        
        // Preload sound effects
        preloadSounds();
        
        // Set up keyboard controls
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        
        // Set up popup click to close
        document.addEventListener('click', function(e) {
            if (gameData.battle.showPopup && !e.target.closest('.teacher-popup')) {
                closeTeacherPopup();
            }
        });
        
        // Set up popup key to close
        document.addEventListener('keydown', function(e) {
            if (gameData.battle.showPopup) {
                closeTeacherPopup();
            }
        });
        
        // Set up video event listeners for Modi video
        const modiVideo = document.getElementById('modi-video');
        if (modiVideo) {
            modiVideo.removeAttribute('controls');
            
            modiVideo.addEventListener('ended', function() {
                console.log('Modi Video ended');
                endVideo('modi');
            });
            
            modiVideo.addEventListener('error', function(e) {
                console.log('Modi Video error:', e);
                skipVideo('modi');
            });
            
            modiVideo.addEventListener('canplay', function() {
                console.log('Modi Video can play');
            });
        }
        
        // Set up video event listeners for RN video
        const rnVideo = document.getElementById('rn-video');
        if (rnVideo) {
            rnVideo.removeAttribute('controls');
            
            rnVideo.addEventListener('ended', function() {
                console.log('RN Video ended');
                endVideo('rn');
            });
            
            rnVideo.addEventListener('error', function(e) {
                console.log('RN Video error:', e);
                skipVideo('rn');
            });
            
            rnVideo.addEventListener('canplay', function() {
                console.log('RN Video can play');
            });
        }
        
        // Game loop
        setInterval(gameLoop, 1000/60);
        
        // Update special cooldown
        setInterval(updateSpecialCooldown, 100);
        
        // Update teacher special cooldown
        setInterval(updateTeacherSpecial, 100);
        
        // Random sound effects during gameplay (with intro check)
        setInterval(playRandomGameSound, 10000);
        
        // Initialize mobile controls
        updateMobileControls();
        window.addEventListener('resize', updateMobileControls);
    });

    // Initialize audio
    function initAudio() {
        try {
            gameData.sounds.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log("Audio initialized successfully");
        } catch (e) {
            console.log("Web Audio API not supported, using HTML5 Audio");
            gameData.sounds.enabled = false;
        }
    }

    // Preload sounds
    function preloadSounds() {
        for (const [name, url] of Object.entries(soundLibrary)) {
            const audio = new Audio();
            audio.src = url;
            audio.preload = 'auto';
            audio.onended = function() {
                gameData.sounds.currentlyPlaying.delete(name);
            };
            gameData.sounds.audioElements[name] = audio;
        }
    }

    // Enhanced Play sound effect with priority management
    function playSoundEffect(soundName, volume = 0.7, allowMultiple = false) {
        if (!gameData.sounds.enabled) return null;
        
        const priority = gameData.sounds.soundPriority[soundName] || 0;
        
        // Check if any high priority intro is playing
        if ((gameData.sounds.currentlyPlaying.has('RNintro') || gameData.sounds.currentlyPlaying.has('ModiIntro')) && 
            !['RNintro', 'ModiIntro'].includes(soundName)) {
            return null;
        }
        
        // Check if any higher priority sound is playing
        if (!['RNintro', 'ModiIntro'].includes(soundName)) {
            for (const playingSound of gameData.sounds.currentlyPlaying) {
                const playingPriority = gameData.sounds.soundPriority[playingSound] || 0;
                if (playingPriority > priority) {
                    return null; // Higher priority sound is playing
                }
            }
        }
        
        // Stop lower priority sounds if this sound has higher priority
        if (['RNintro', 'ModiIntro'].includes(soundName) || priority > 0) {
            gameData.sounds.currentlyPlaying.forEach(playingSound => {
                const playingPriority = gameData.sounds.soundPriority[playingSound] || 0;
                if (playingPriority < priority) {
                    const audio = gameData.sounds.audioElements[playingSound];
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    gameData.sounds.currentlyPlaying.delete(playingSound);
                }
            });
        }
        
        // Check if we should play multiple instances
        if (!allowMultiple && gameData.sounds.playedSounds.has(soundName)) {
            return null;
        }
        
        const audio = gameData.sounds.audioElements[soundName];
        if (!audio) {
            console.warn(`Sound not found: ${soundName}`);
            return null;
        }
        
        try {
            // Reset audio if it's already playing
            audio.currentTime = 0;
            audio.volume = volume;
            
            // Play the sound
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    gameData.sounds.currentlyPlaying.add(soundName);
                }).catch(error => {
                    console.log("Audio play failed:", error);
                });
            }
            
            // Track played sound
            gameData.sounds.playedSounds.add(soundName);
            
            // Clear from set after sound duration
            setTimeout(() => {
                gameData.sounds.playedSounds.delete(soundName);
            }, 2000);
            
            return audio;
            
        } catch (e) {
            console.log("Sound error:", e);
            return null;
        }
    }

    // Play random game sound with intro check
    function playRandomGameSound() {
        if (!gameData.battle.gameActive || gameData.battle.showPopup || gameData.battle.isSpawning) return;
        
        // Don't play random sounds if any intro is playing
        if (gameData.sounds.currentlyPlaying.has('RNintro') || gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            return;
        }
        
        const gameSounds = ['Burp', 'Rubber Duck', 'Crickets', 'Alert'];
        const randomSound = gameSounds[Math.floor(Math.random() * gameSounds.length)];
        
        if (Math.random() < 0.2) { // 20% chance
            playSoundEffect(randomSound, 0.3, true);
        }
    }

    // Play teacher spawn sound with priority management
    function playTeacherSpawnSound(teacherName) {
        if (!gameData.sounds.enabled) return;
        
        // Don't play teacher spawn sound if any intro is playing
        if (gameData.sounds.currentlyPlaying.has('RNintro') || gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            return;
        }
        
        if (teacherName === "MODI" || teacherName === "PUNIT") {
            playSoundEffect('Wow', 0.8);
        } else if (teacherName === "SREELEKHA") {
            playSoundEffect('Goat Scream', 0.7);
        } else if (teacherName === "ANUJ") {
            playSoundEffect('Alert', 0.6);
        }
        // RN gets special video treatment, no spawn sound needed
    }

    // Play match start sound
    function playMatchStartSound() {
        if (!gameData.sounds.enabled) return;
        // Don't play if any intro is playing
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('Taco Bell', 0.8);
        }
    }

    // Play student death sound
    function playStudentDeathSound() {
        if (!gameData.sounds.enabled) return;
        // Don't play if any intro is playing
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('GTA 5 Wasted', 0.9);
        }
    }

    // Play teacher death sound
    function playTeacherDeathSound(teacherName) {
        if (!gameData.sounds.enabled) return;
        
        // Don't play if any intro is playing
        if (gameData.sounds.currentlyPlaying.has('RNintro') || gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            return;
        }
        
        if (teacherName === "SREELEKHA") {
            playSoundEffect('No God Please No', 0.8);
        } else if (teacherName === "RN") {
            playSoundEffect('Ohhhhhhhhhh', 0.8);
        } else {
            playSoundEffect('Oh No No No', 0.7);
        }
    }

    // Toggle sound
    function toggleSound() {
        gameData.sounds.enabled = !gameData.sounds.enabled;
        document.getElementById('sound-btn').textContent = gameData.sounds.enabled ? '🔊' : '🔇';
        
        if (gameData.sounds.enabled) {
            playSoundEffect('Alert', 0.3);
        }
    }

    // Toggle music
    function toggleMusic() {
        gameData.sounds.musicEnabled = !gameData.sounds.musicEnabled;
        document.getElementById('music-btn').textContent = gameData.sounds.musicEnabled ? '🎵' : '🔇';
        playSoundEffect('Alert', 0.3);
    }

    // Toggle controls menu
    function toggleControls() {
        const content = document.getElementById('controls-content');
        const arrow = document.getElementById('controls-arrow');
        
        content.classList.toggle('expanded');
        arrow.textContent = content.classList.contains('expanded') ? '▲' : '▼';
        
        playSoundEffect('Alert', 0.3);
    }

    // Load students
    function loadStudents() {
        const container = document.getElementById('student-characters');
        container.innerHTML = '';
        
        gameData.students.forEach(student => {
            const card = document.createElement('div');
            card.className = 'character-card';
            card.onclick = () => selectStudent(student);
            
            // Create image with error handling
            const img = document.createElement('img');
            img.className = 'character-img';
            img.src = student.image;
            img.alt = student.name;
            img.onerror = function() {
                this.src = `https://ui-avatars.com/api/?name=${student.name}&background=0ea5e9&color=fff&size=80`;
            };
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'character-name';
            nameDiv.textContent = student.name;
            
            card.appendChild(img);
            card.appendChild(nameDiv);
            
            container.appendChild(card);
        });
    }

    // Load teachers
    function loadTeachers() {
        const container = document.getElementById('teacher-characters');
        container.innerHTML = '';
        
        gameData.teachers.forEach(teacher => {
            const card = document.createElement('div');
            card.className = 'character-card';
            
            const img = document.createElement('img');
            img.className = 'character-img';
            img.src = teacher.image;
            img.alt = teacher.name;
            img.onerror = function() {
                this.src = `https://ui-avatars.com/api/?name=${teacher.name}&background=ec4899&color=fff&size=80`;
            };
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'character-name';
            nameDiv.textContent = teacher.name;
            
            card.appendChild(img);
            card.appendChild(nameDiv);
            
            container.appendChild(card);
        });
    }

    // Load high scores
    function loadHighScores() {
        const container = document.getElementById('highscore-list');
        container.innerHTML = '';
        
        gameData.highScores.forEach((score, index) => {
            const item = document.createElement('li');
            item.className = 'highscore-item';
            
            item.innerHTML = `
                <div class="score-rank">${index + 1}</div>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 600; color: #00d4ff; font-size: 1rem;">${score.name}</div>
                    <div style="font-size: 0.8rem; color: #94a3b8;">Round ${score.round} • ${score.teachersDefeated} teachers</div>
                </div>
                <div style="font-weight: 700; color: #ffd700; font-size: 1.1rem;">${score.score.toLocaleString()}</div>
            `;
            
            container.appendChild(item);
        });
    }

    // Select student
    function selectStudent(student) {
        gameData.selectedStudent = student;
        
        // Update UI
        document.querySelectorAll('#student-characters .character-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        // Update selected display
        document.getElementById('selected-text').innerHTML = `
            <span style="color: #00d4ff;">${student.name}</span>
            <span style="display: block; font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">Ready for battle</span>
        `;
        
        playSoundEffect('Alert', 0.3);
    }

    // Switch screens
    function showScreen(screenId) {
        // Hide all screens
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        
        // Show requested screen
        document.getElementById(screenId).classList.add('active');
        
        // Initialize battle if going to battle screen
        if (screenId === 'battle-screen') {
            if (gameData.selectedStudent) {
                initializeBattle();
            } else {
                alert('Please select a student first!');
                showScreen('dashboard-screen');
            }
        }
        
        // Reset keys
        gameData.battle.keysPressed = {};
        
        playSoundEffect('Alert', 0.3);
    }

    // Start battle
    function startBattle() {
        if (!gameData.selectedStudent) {
            alert('Please select a student first!');
            return;
        }
        
        showScreen('battle-screen');
        playSoundEffect('Inception', 0.6);
    }

    // Initialize battle
    function initializeBattle() {
        // Reset teacher tracking
        gameData.remainingTeachers = [...gameData.teachers]; // Copy all teachers
        gameData.teacherOrder = [];
        
        // Create teacher order: SREELEKHA first, MODI second, RN third, then others
        const sreelekhaTeacher = gameData.remainingTeachers.find(t => t.id === 2); // SREELEKHA
        const modiTeacher = gameData.remainingTeachers.find(t => t.id === 1); // MODI
        const rnTeacher = gameData.remainingTeachers.find(t => t.id === 3); // RN
        const otherTeachers = gameData.remainingTeachers.filter(t => t.id !== 1 && t.id !== 2 && t.id !== 3); // All except SREELEKHA, MODI, RN
        
        // Shuffle other teachers
        shuffleArray(otherTeachers);
        
        // Create order: SREELEKHA first, MODI second, RN third, then others
        if (sreelekhaTeacher) {
            gameData.teacherOrder.push(sreelekhaTeacher); // SREELEKHA first
        }
        if (modiTeacher) {
            gameData.teacherOrder.push(modiTeacher); // MODI second
        }
        if (rnTeacher) {
            gameData.teacherOrder.push(rnTeacher); // RN third
        }
        // Add remaining teachers
        for (let i = 0; i < otherTeachers.length; i++) {
            gameData.teacherOrder.push(otherTeachers[i]);
        }
        
        // Reset battle state
        resetBattleState();
        
        // Reset sound states
        gameData.sounds.playedSounds.clear();
        gameData.sounds.currentlyPlaying.clear();
        
        // Reset teacher cooldowns
        gameData.teachers.forEach(teacher => {
            teacher.lastSpecial = 0;
            if (teacher.sprite) {
                teacher.sprite.currentSprite = 'idle';
                teacher.sprite.walkFrame = 0;
                teacher.sprite.walkTimer = 0;
            }
        });
        
        // Set student
        document.getElementById('student-name').textContent = gameData.selectedStudent.name;
        
        // Select first teacher from the order (SREELEKHA)
        selectNextTeacher();
        
        // Create character elements
        createCharacterElements();
        
        // Reset special attack
        updateSpecialUI();
        updateMobileSpecialUI();
        
        // Update UI
        updateBattleUI();
        updateHealthBars();
        
        // Play match start sound
        playMatchStartSound();
        
        // Show teacher popup for first teacher
        setTimeout(() => {
            showTeacherPopup();
        }, 500);
    }

    // Reset battle state
    function resetBattleState() {
        gameData.battle = {
            studentHealth: 100,
            teacherHealth: 100,
            gameActive: true,
            startTime: Date.now(),
            totalScore: 0,
            teachersDefeated: 0,
            currentRound: 1,
            studentPosition: { x: 50, y: 150 },
            teacherPosition: { x: 300, y: 150 },
            keysPressed: {},
            projectiles: [],
            isSpawning: false,
            moveDirection: null,
            specialAttackReady: true,
            specialCooldown: 0,
            specialMaxCooldown: 5000,
            specialCooldownInterval: null,
            showPopup: false,
            activeEffects: [],
            teacherSpecialReady: true,
            lastUpdate: Date.now(),
            teacherSpriteImages: {},
            teacherWalking: false,
            teacherLastWalkUpdate: 0,
            playingVideo: false,
            videoType: null,
            videoSkipTimer: null,
            videoSkipSeconds: 3,
            skipButton: null
        };
    }

    // Shuffle array function
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Select next teacher from the order
    function selectNextTeacher() {
        if (gameData.teacherOrder.length === 0) {
            // All teachers defeated - show victory screen
            showVictoryScreen();
            return;
        }
        
        gameData.currentTeacher = gameData.teacherOrder.shift(); // Remove and get first teacher
        
        document.getElementById('teacher-name').textContent = gameData.currentTeacher.name;
        
        // Check if this teacher has a video
        if (gameData.currentTeacher.hasVideo) {
            // Play video before spawning
            if (gameData.currentTeacher.id === 1) { // MODI
                playVideo('modi');
            } else if (gameData.currentTeacher.id === 3) { // RN
                playVideo('rn');
            }
        } else {
            // Play regular teacher spawn sound
            playTeacherSpawnSound(gameData.currentTeacher.name);
            
            // Preload teacher sprite images if teacher uses sprites
            if (gameData.currentTeacher.useSprite) {
                preloadTeacherSprites();
            }
            
            // Continue with normal spawn
            continueAfterVideo();
        }
    }

    // Show victory screen when all teachers are defeated
    function showVictoryScreen() {
        gameData.battle.gameActive = false;
        
        const battleTime = Math.floor((Date.now() - gameData.battle.startTime) / 1000);
        
        // Update victory stats
        document.getElementById('victory-teachers').textContent = gameData.battle.teachersDefeated;
        document.getElementById('victory-score').textContent = gameData.battle.totalScore.toLocaleString();
        document.getElementById('victory-time').textContent = battleTime;
        
        // Show victory screen
        document.getElementById('victory-screen').style.display = 'flex';
        
        // Play victory sound
        playSoundEffect('Heavenly Sound', 0.8);
        playSoundEffect('Crowd Laughing', 0.6);
    }

    // Play video for teacher
    function playVideo(videoType) {
        console.log(`Playing ${videoType.toUpperCase()} Video`);
        gameData.battle.playingVideo = true;
        gameData.battle.videoType = videoType;
        gameData.battle.gameActive = false;
        
        const videoOverlay = document.getElementById(`${videoType}-video-overlay`);
        const video = document.getElementById(`${videoType}-video`);
        const skipButton = document.querySelector(`#${videoType}-video-overlay .video-skip`);
        
        // Show video overlay
        videoOverlay.style.display = 'flex';
        
        // For RN video, show scary text
        if (videoType === 'rn') {
            const scaryText = document.getElementById('rn-scary-text');
            scaryText.style.display = 'flex';
        }
        
        // Start skip timer
        let skipSeconds = 3;
        skipButton.textContent = `SKIP (${skipSeconds})`;
        skipButton.style.display = 'block';
        
        // Clear any existing timer
        if (gameData.battle.videoSkipTimer) {
            clearInterval(gameData.battle.videoSkipTimer);
        }
        
        gameData.battle.videoSkipTimer = setInterval(() => {
            skipSeconds--;
            if (skipSeconds <= 0) {
                clearInterval(gameData.battle.videoSkipTimer);
                gameData.battle.videoSkipTimer = null;
                skipButton.textContent = 'SKIP';
                
                // For RN video, hide scary text after 3 seconds
                if (videoType === 'rn') {
                    setTimeout(() => {
                        const scaryText = document.getElementById('rn-scary-text');
                        scaryText.style.display = 'none';
                    }, 500);
                }
            } else {
                skipButton.textContent = `SKIP (${skipSeconds})`;
            }
        }, 1000);
        
        // Configure and play video
        video.currentTime = 0;
        video.volume = 1.0;
        video.muted = false;
        
        // Play video with promise handling
        const playPromise = video.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log(`${videoType.toUpperCase()} Video started playing`);
            }).catch(error => {
                console.log(`${videoType.toUpperCase()} Video play failed:`, error);
                // If video fails to play, skip it after 1 second
                setTimeout(() => {
                    skipVideo(videoType);
                }, 1000);
            });
        }
    }

    // Skip video
    function skipVideo(videoType) {
        console.log(`Skipping ${videoType.toUpperCase()} Video`);
        const videoOverlay = document.getElementById(`${videoType}-video-overlay`);
        const video = document.getElementById(`${videoType}-video`);
        
        // For RN video, hide scary text
        if (videoType === 'rn') {
            const scaryText = document.getElementById('rn-scary-text');
            scaryText.style.display = 'none';
        }
        
        // Clear skip timer
        if (gameData.battle.videoSkipTimer) {
            clearInterval(gameData.battle.videoSkipTimer);
            gameData.battle.videoSkipTimer = null;
        }
        
        // Hide video overlay
        videoOverlay.style.display = 'none';
        
        // Pause and reset video
        video.pause();
        video.currentTime = 0;
        
        // Continue with teacher spawn
        continueAfterVideo();
    }

    // End video and continue
    function endVideo(videoType) {
        console.log(`${videoType.toUpperCase()} Video ended, spawning teacher`);
        const videoOverlay = document.getElementById(`${videoType}-video-overlay`);
        const video = document.getElementById(`${videoType}-video`);
        
        // For RN video, hide scary text
        if (videoType === 'rn') {
            const scaryText = document.getElementById('rn-scary-text');
            scaryText.style.display = 'none';
        }
        
        // Clear skip timer
        if (gameData.battle.videoSkipTimer) {
            clearInterval(gameData.battle.videoSkipTimer);
            gameData.battle.videoSkipTimer = null;
        }
        
        // Hide video overlay
        videoOverlay.style.display = 'none';
        
        // Pause and reset video
        video.pause();
        video.currentTime = 0;
        
        // Continue with teacher spawn
        continueAfterVideo();
    }

    // Skip Modi video
    function skipModiVideo() {
        skipVideo('modi');
    }

    // Skip RN video
    function skipRNVideo() {
        skipVideo('rn');
    }

    // End Modi video
    function endModiVideo() {
        endVideo('modi');
    }

    // End RN video
    function endRNVideo() {
        endVideo('rn');
    }

    // Continue after video ends
    function continueAfterVideo() {
        gameData.battle.playingVideo = false;
        gameData.battle.videoType = null;
        
        // Play appropriate intro sound
        if (gameData.currentTeacher.id === 1) { // MODI
            playSoundEffect('ModiIntro', 0.8);
        } else if (gameData.currentTeacher.id === 3) { // RN
            playSoundEffect('RNintro', 0.8);
        }
        
        // Preload teacher sprite images if teacher uses sprites
        if (gameData.currentTeacher.useSprite) {
            preloadTeacherSprites();
        }
        
        // Reset positions
        const arena = document.getElementById('battle-arena');
        const arenaRect = arena.getBoundingClientRect();
        
        gameData.battle.studentPosition.x = 50;
        gameData.battle.studentPosition.y = arenaRect.height / 2 - (window.innerWidth <= 768 ? 30 : 44);
        gameData.battle.teacherPosition.x = arenaRect.width - 120;
        gameData.battle.teacherPosition.y = arenaRect.height / 2 - (window.innerWidth <= 768 ? 28 : 35);
        
        // Reset teacher health (increase with rounds)
        gameData.battle.teacherHealth = 100 + (gameData.battle.currentRound - 1) * 20;
        
        // Heal student slightly between rounds
        gameData.battle.studentHealth = Math.min(100, gameData.battle.studentHealth + 10);
        
        // Remove old teacher element
        const oldTeacherSquare = document.getElementById('teacher-square');
        const oldTeacherSprite = document.getElementById('teacher-sprite');
        if (oldTeacherSquare) oldTeacherSquare.remove();
        if (oldTeacherSprite) oldTeacherSprite.remove();
        
        // Create new teacher element based on type
        createCharacterElements();
        
        // Update UI
        document.getElementById('teacher-name').textContent = gameData.currentTeacher.name;
        updatePositions();
        updateBattleUI();
        updateHealthBars();
        
        // Resume game
        gameData.battle.isSpawning = false;
        gameData.battle.gameActive = true;
        
        // Show teacher popup for the teacher
        setTimeout(() => {
            showTeacherPopup();
        }, 300);
    }

    // Preload teacher sprite images
    function preloadTeacherSprites() {
        const teacher = gameData.currentTeacher;
        if (!teacher || !teacher.useSprite || !teacher.sprite) return;
        
        const spriteUrls = [
            teacher.sprite.duck,
            teacher.sprite.front,
            teacher.sprite.hit,
            teacher.sprite.idle,
            teacher.sprite.jump,
            teacher.sprite.walkA,
            teacher.sprite.walkB
        ];
        
        spriteUrls.forEach(url => {
            if (url && !gameData.battle.teacherSpriteImages[url]) {
                const img = new Image();
                img.src = url;
                gameData.battle.teacherSpriteImages[url] = img;
            }
        });
    }

    // Get current teacher sprite
    function getCurrentTeacherSprite() {
        if (!gameData.currentTeacher || !gameData.currentTeacher.useSprite || !gameData.currentTeacher.sprite) {
            return null;
        }
        
        const sprite = gameData.currentTeacher.sprite;
        let spriteUrl = sprite.idle; // Default
        
        // Determine which sprite to use based on state
        if (gameData.battle.teacherWalking) {
            // Alternate between walkA and walkB for walking animation
            const currentTime = Date.now();
            if (currentTime - gameData.battle.teacherLastWalkUpdate > sprite.walkSpeed) {
                gameData.battle.teacherLastWalkUpdate = currentTime;
                sprite.walkFrame = sprite.walkFrame === 0 ? 1 : 0;
            }
            spriteUrl = sprite.walkFrame === 0 ? sprite.walkA : sprite.walkB;
        } else if (sprite.currentSprite === 'hit') {
            spriteUrl = sprite.hit;
        } else if (sprite.currentSprite === 'jump') {
            spriteUrl = sprite.jump;
        } else if (sprite.currentSprite === 'duck') {
            spriteUrl = sprite.duck;
        } else if (sprite.currentSprite === 'front') {
            spriteUrl = sprite.front;
        }
        
        return spriteUrl;
    }

    // Create character elements
    function createCharacterElements() {
        const arena = document.getElementById('battle-arena');
        arena.innerHTML = '';
        
        // Create student square
        const studentSquare = document.createElement('div');
        studentSquare.className = 'character-square student-square';
        studentSquare.id = 'student-square';
        studentSquare.style.left = gameData.battle.studentPosition.x + 'px';
        studentSquare.style.top = gameData.battle.studentPosition.y + 'px';
        studentSquare.style.backgroundImage = `url('${gameData.selectedStudent.image}')`;
        arena.appendChild(studentSquare);
        
        // Create teacher element - either sprite or square
        if (gameData.currentTeacher.useSprite) {
            // Create sprite container for teacher
            const teacherSprite = document.createElement('div');
            teacherSprite.className = 'teacher-sprite-container';
            teacherSprite.id = 'teacher-sprite';
            teacherSprite.style.position = 'absolute';
            teacherSprite.style.left = gameData.battle.teacherPosition.x + 'px';
            teacherSprite.style.top = gameData.battle.teacherPosition.y + 'px';
            teacherSprite.style.width = (gameData.currentTeacher.sprite.width * gameData.currentTeacher.sprite.scale) + 'px';
            teacherSprite.style.height = (gameData.currentTeacher.sprite.height * gameData.currentTeacher.sprite.scale) + 'px';
            teacherSprite.style.backgroundImage = `url('${gameData.currentTeacher.sprite.idle}')`;
            teacherSprite.style.backgroundSize = 'contain';
            teacherSprite.style.backgroundRepeat = 'no-repeat';
            teacherSprite.style.backgroundPosition = 'center';
            teacherSprite.style.zIndex = '10';
            arena.appendChild(teacherSprite);
        } else {
            // Create regular square for teachers without sprites
            const teacherSquare = document.createElement('div');
            teacherSquare.className = 'character-square teacher-square';
            teacherSquare.id = 'teacher-square';
            teacherSquare.style.left = gameData.battle.teacherPosition.x + 'px';
            teacherSquare.style.top = gameData.battle.teacherPosition.y + 'px';
            teacherSquare.style.backgroundImage = `url('${gameData.currentTeacher.image}')`;
            arena.appendChild(teacherSquare);
        }
    }

    // Update teacher sprite
    function updateTeacherSprite() {
        if (!gameData.currentTeacher || !gameData.currentTeacher.useSprite) {
            return;
        }
        
        const teacherSprite = document.getElementById('teacher-sprite');
        if (!teacherSprite) return;
        
        // Update position
        teacherSprite.style.left = gameData.battle.teacherPosition.x + 'px';
        teacherSprite.style.top = gameData.battle.teacherPosition.y + 'px';
        
        // Update sprite image based on state
        const currentSprite = getCurrentTeacherSprite();
        if (currentSprite) {
            teacherSprite.style.backgroundImage = `url('${currentSprite}')`;
        }
        
        // Flip sprite based on movement direction
        const dx = gameData.battle.studentPosition.x - gameData.battle.teacherPosition.x;
        if (dx !== 0) {
            teacherSprite.style.transform = dx < 0 ? 'scaleX(-1)' : 'scaleX(1)';
        }
    }

    // Show teacher comic popup
    function showTeacherPopup() {
        if (!gameData.currentTeacher) return;
        
        gameData.battle.showPopup = true;
        gameData.battle.gameActive = false;
        
        const popup = document.getElementById('teacher-popup');
        const teacher = gameData.currentTeacher;
        
        // Set popup content
        document.getElementById('popup-teacher-image').src = teacher.image;
        document.getElementById('popup-teacher-image').alt = teacher.name;
        document.getElementById('popup-teacher-name').textContent = teacher.name;
        document.getElementById('popup-teacher-message').textContent = teacher.message;
        
        // Show popup
        popup.style.display = 'block';
        
        // Play teacher entrance sound (unless intro is already playing)
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('Alert', 0.5);
        }
        
        // Auto-close after 5 seconds
        setTimeout(() => {
            if (gameData.battle.showPopup) {
                closeTeacherPopup();
            }
        }, 5000);
    }

    // Close teacher popup
    function closeTeacherPopup() {
        const popup = document.getElementById('teacher-popup');
        popup.style.display = 'none';
        gameData.battle.showPopup = false;
        
        // Resume game
        gameData.battle.gameActive = true;
        
        // Play resume sound (unless intro is playing)
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('Alert', 0.3);
        }
    }

    // Update battle UI
    function updateBattleUI() {
        document.getElementById('round-count').textContent = gameData.battle.currentRound;
        document.getElementById('teachers-defeated').textContent = gameData.battle.teachersDefeated;
        document.getElementById('current-score').textContent = gameData.battle.totalScore.toLocaleString();
    }

    // Update health bars
    function updateHealthBars() {
        const studentHealthPercent = (gameData.battle.studentHealth / 100) * 100;
        const teacherHealthPercent = (gameData.battle.teacherHealth / 100) * 100;
        
        document.getElementById('student-health-bar').style.width = `${studentHealthPercent}%`;
        document.getElementById('teacher-health-bar').style.width = `${teacherHealthPercent}%`;
        
        document.getElementById('student-health-text').textContent = 
            `${Math.max(0, gameData.battle.studentHealth)}/100`;
        document.getElementById('teacher-health-text').textContent = 
            `${Math.max(0, gameData.battle.teacherHealth)}/100`;
        
        // Check win conditions
        if (gameData.battle.teacherHealth <= 0) {
            teacherDefeated();
        } else if (gameData.battle.studentHealth <= 0) {
            endBattle('teacher');
        }
    }

    // Handle keyboard input
    function handleKeyDown(event) {
        if (gameData.battle.showPopup) return;
        if (!gameData.battle.gameActive) return;
        
        const key = event.key.toLowerCase();
        gameData.battle.keysPressed[key] = true;
        
        // Shoot on space
        if (key === ' ' && !event.repeat) {
            shootProjectile();
            event.preventDefault();
        }
        
        // Special attack on shift
        if (key === 'shift' && gameData.battle.specialAttackReady && !event.repeat) {
            specialAttack();
        }
        
        // Pause on escape
        if (key === 'escape') {
            // You could add a pause feature here
            alert('Game paused - Press OK to continue');
        }
    }

    function handleKeyUp(event) {
        const key = event.key.toLowerCase();
        gameData.battle.keysPressed[key] = false;
    }

    // Update special cooldown
    function updateSpecialCooldown() {
        if (!gameData.battle.gameActive || gameData.battle.showPopup) return;
        
        if (!gameData.battle.specialAttackReady) {
            gameData.battle.specialCooldown -= 100;
            
            if (gameData.battle.specialCooldown <= 0) {
                gameData.battle.specialAttackReady = true;
                gameData.battle.specialCooldown = 0;
                updateMobileSpecialUI();
            }
            
            updateSpecialUI();
        }
    }

    // Update teacher special cooldown
    function updateTeacherSpecial() {
        if (!gameData.battle.gameActive || gameData.battle.showPopup || !gameData.currentTeacher) return;
        
        const currentTime = Date.now();
        const teacher = gameData.currentTeacher;
        
        // Check if teacher can use special attack
        if (currentTime - teacher.lastSpecial > teacher.specialCooldown) {
            // Random chance to use special attack
            if (Math.random() < 0.005) { // 0.5% chance per 100ms
                triggerTeacherSpecialAttack();
            }
        }
    }

    // Trigger teacher special attack
    function triggerTeacherSpecialAttack() {
        if (!gameData.currentTeacher || !gameData.battle.gameActive) return;
        
        const teacher = gameData.currentTeacher;
        teacher.lastSpecial = Date.now();
        
        // Don't trigger special attack sound if intro is playing
        if (gameData.sounds.currentlyPlaying.has('RNintro') || gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            return;
        }
        
        // Show notification
        showSpecialAttackNotification(teacher.name + " uses " + getSpecialAttackName(teacher.specialAttack) + "!");
        
        // Play special attack sound based on teacher
        switch(teacher.specialAttack) {
            case 'demonetization':
                playSoundEffect('Alert', 0.6);
                break;
            case 'parentMeeting':
                playSoundEffect('Crowd Laughing', 0.5);
                break;
            case 'attendance':
                playSoundEffect('Alert', 0.7);
                break;
            case 'surpriseTest':
                playSoundEffect('Inception', 0.5);
                break;
            case 'birthdayParty':
                playSoundEffect('Ohhhhhhhhhh', 0.6);
                break;
        }
        
        // For teachers with sprites, show hit sprite briefly
        if (teacher.useSprite && teacher.sprite) {
            teacher.sprite.currentSprite = 'hit';
            setTimeout(() => {
                teacher.sprite.currentSprite = 'idle';
            }, 500);
        }
        
        // Execute special attack
        switch(teacher.specialAttack) {
            case 'demonetization':
                demonetizationAttack();
                break;
            case 'parentMeeting':
                parentMeetingAttack();
                break;
            case 'attendance':
                attendanceAttack();
                break;
            case 'surpriseTest':
                surpriseTestAttack();
                break;
            case 'birthdayParty':
                birthdayPartyAttack();
                break;
        }
    }

    // Get special attack display name
    function getSpecialAttackName(special) {
        const names = {
            demonetization: "💰 Demonetization",
            parentMeeting: "👻 Parent Meeting",
            attendance: "📝 Attendance Check",
            surpriseTest: "📚 Surprise Test",
            birthdayParty: "🎉 Birthday Party"
        };
        return names[special] || special;
    }

    // Show special attack notification
    function showSpecialAttackNotification(text) {
        const notification = document.createElement('div');
        notification.className = 'special-attack-notification';
        notification.textContent = text;
        
        document.body.appendChild(notification);
        
        // Remove after animation
        setTimeout(() => {
            notification.remove();
        }, 1500);
    }

    // Modi: Demonetization - Removes 50% of score
    function demonetizationAttack() {
        const oldScore = gameData.battle.totalScore;
        gameData.battle.totalScore = Math.floor(gameData.battle.totalScore * 0.5);
        const scoreLost = oldScore - gameData.battle.totalScore;
        
        // Create effect
        const arena = document.getElementById('battle-arena');
        const effect = document.createElement('div');
        effect.className = 'special-attack-effect demonetization-effect';
        arena.appendChild(effect);
        
        // Show score loss
        showDamageNumber(gameData.battle.studentPosition.x + 35, 
                       gameData.battle.studentPosition.y + 35, 
                       `-${scoreLost} Score`);
        
        // Play cringe sound (if intro isn't playing)
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('Burp', 0.5);
        }
        
        // Remove effect
        setTimeout(() => {
            effect.remove();
        }, 2000);
        
        updateBattleUI();
    }

    // RN Sir: Parent Meeting - Summons angry parent ghosts
    function parentMeetingAttack() {
        const arena = document.getElementById('battle-arena');
        const arenaRect = arena.getBoundingClientRect();
        
        // Create 3 parent ghosts
        for (let i = 0; i < 3; i++) {
            const ghost = document.createElement('div');
            ghost.className = 'parent-ghost';
            ghost.style.left = Math.random() * (arenaRect.width - 50) + 'px';
            ghost.style.top = Math.random() * (arenaRect.height - 50) + 'px';
            arena.appendChild(ghost);
            
            // Ghost moves toward student
            const ghostData = {
                element: ghost,
                x: parseInt(ghost.style.left),
                y: parseInt(ghost.style.top),
                speed: 2,
                active: true
            };
            
            gameData.battle.activeEffects.push(ghostData);
        }
        
        // Remove ghosts after 5 seconds
        setTimeout(() => {
            gameData.battle.activeEffects = gameData.battle.activeEffects.filter(effect => {
                if (effect.element.classList.contains('parent-ghost')) {
                    effect.element.remove();
                    return false;
                }
                return true;
            });
        }, 5000);
    }

    // Sreelekha: Attendance Check - Freezes student in place
    function attendanceAttack() {
        // Create freeze effect
        const arena = document.getElementById('battle-arena');
        const effect = document.createElement('div');
        effect.className = 'special-attack-effect attendance-freeze';
        arena.appendChild(effect);
        
        // Freeze student controls for 3 seconds
        const originalGameActive = gameData.battle.gameActive;
        gameData.battle.gameActive = false;
        
        // Play annoying sound repeatedly (if intro isn't playing)
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            const attendanceSound = setInterval(() => {
                playSoundEffect('Alert', 0.4, true);
            }, 500);
            
            // Restore after 3 seconds
            setTimeout(() => {
                gameData.battle.gameActive = originalGameActive;
                effect.remove();
                clearInterval(attendanceSound);
            }, 3000);
        } else {
            // If intro is playing, just freeze without sound
            setTimeout(() => {
                gameData.battle.gameActive = originalGameActive;
                effect.remove();
            }, 3000);
        }
    }

    // Anuj: Surprise Test - Randomly damages health
    function surpriseTestAttack() {
        // Create multiple test effects
        const arena = document.getElementById('battle-arena');
        const arenaRect = arena.getBoundingClientRect();
        
        for (let i = 0; i < 5; i++) {
            const testEffect = document.createElement('div');
            testEffect.className = 'surprise-test-effect';
            testEffect.style.left = Math.random() * (arenaRect.width - 30) + 'px';
            testEffect.style.top = Math.random() * (arenaRect.height - 30) + 'px';
            arena.appendChild(testEffect);
            
            // Check if near student
            setTimeout(() => {
                const dx = gameData.battle.studentPosition.x - parseInt(testEffect.style.left);
                const dy = gameData.battle.studentPosition.y - parseInt(testEffect.style.top);
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 100) {
                    gameData.battle.studentHealth -= 15;
                    updateHealthBars();
                    if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
                        playSoundEffect('Alert', 0.5);
                    }
                }
                
                testEffect.remove();
            }, 1000);
        }
    }

    // Punit: Birthday Party - Confetti that blocks vision
    function birthdayPartyAttack() {
        const arena = document.getElementById('battle-arena');
        const arenaRect = arena.getBoundingClientRect();
        
        // Create confetti
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * arenaRect.width + 'px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.opacity = Math.random() * 0.5 + 0.5;
            
            arena.appendChild(confetti);
            
            // Remove after animation
            setTimeout(() => {
                if (confetti.parentNode) {
                    confetti.remove();
                }
            }, 3000);
        }
        
        // Play birthday sound (if intro isn't playing)
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('Ohhhhhhhhhh', 0.6);
        }
    }

    // Update special attack UI
    function updateSpecialUI() {
        const cooldownPercent = (gameData.battle.specialCooldown / gameData.battle.specialMaxCooldown) * 100;
        const remainingSeconds = Math.ceil(gameData.battle.specialCooldown / 1000);
        
        // Update dashboard cooldown
        document.getElementById('cooldown-time').textContent = remainingSeconds > 0 ? `${remainingSeconds}s` : 'Ready';
        document.getElementById('cooldown-fill').style.width = `${100 - cooldownPercent}%`;
        
        // Update battle cooldown
        const specialText = document.getElementById('special-text');
        const specialBar = document.getElementById('special-cooldown-bar');
        
        if (gameData.battle.specialAttackReady) {
            specialText.textContent = 'Special Ready';
            specialText.className = 'special-ready';
            specialBar.style.width = '100%';
        } else {
            specialText.textContent = `Cooldown: ${remainingSeconds}s`;
            specialText.className = 'special-cooldown-battle';
            specialBar.style.width = `${100 - cooldownPercent}%`;
        }
    }

    // Mobile movement with 8-direction support
    function moveStudent(direction) {
        if (gameData.battle.showPopup || !gameData.battle.gameActive) return;
        
        // Clear previous direction
        gameData.battle.moveDirection = null;
        
        // Set direction components
        switch(direction) {
            case 'up':
                gameData.battle.moveDirection = { x: 0, y: -1 };
                break;
            case 'down':
                gameData.battle.moveDirection = { x: 0, y: 1 };
                break;
            case 'left':
                gameData.battle.moveDirection = { x: -1, y: 0 };
                break;
            case 'right':
                gameData.battle.moveDirection = { x: 1, y: 0 };
                break;
            case 'up-left':
                gameData.battle.moveDirection = { x: -0.707, y: -0.707 };
                break;
            case 'up-right':
                gameData.battle.moveDirection = { x: 0.707, y: -0.707 };
                break;
            case 'down-left':
                gameData.battle.moveDirection = { x: -0.707, y: 0.707 };
                break;
            case 'down-right':
                gameData.battle.moveDirection = { x: 0.707, y: 0.707 };
                break;
        }
    }

    function stopMoveStudent() {
        gameData.battle.moveDirection = null;
    }

    // Mobile special attack
    function mobileSpecialAttack() {
        if (gameData.battle.specialAttackReady) {
            specialAttack();
            updateMobileSpecialUI();
        }
    }

    // Update mobile special attack UI
    function updateMobileSpecialUI() {
        const specialBtn = document.getElementById('mobile-special-btn');
        const specialIndicator = document.getElementById('mobile-special-indicator');
        const specialLabel = document.getElementById('mobile-special-label');
        
        if (gameData.battle.specialAttackReady) {
            specialBtn.classList.remove('cooldown');
            specialIndicator.style.display = 'none';
            specialLabel.textContent = 'READY';
            specialLabel.style.color = '#00ff88';
        } else {
            specialBtn.classList.add('cooldown');
            specialIndicator.style.display = 'flex';
            specialLabel.textContent = 'COOLDOWN';
            specialLabel.style.color = '#ff4757';
            
            // Start countdown timer
            const cooldownSeconds = Math.ceil(gameData.battle.specialCooldown / 1000);
            specialLabel.textContent = `${cooldownSeconds}s`;
            
            const countdownInterval = setInterval(() => {
                const remaining = Math.ceil(gameData.battle.specialCooldown / 1000);
                if (remaining > 0) {
                    specialLabel.textContent = `${remaining}s`;
                } else {
                    clearInterval(countdownInterval);
                    updateMobileSpecialUI();
                }
            }, 1000);
        }
    }

    // Update mobile controls visibility
    function updateMobileControls() {
        const mobileControls = document.getElementById('mobile-controls');
        if (window.innerWidth <= 768) {
            mobileControls.classList.add('active');
        } else {
            mobileControls.classList.remove('active');
        }
    }

    // Game loop
    function gameLoop() {
        if (!gameData.battle.gameActive || gameData.battle.isSpawning || gameData.battle.showPopup || gameData.battle.playingVideo) return;
        
        const now = Date.now();
        const deltaTime = now - gameData.battle.lastUpdate;
        gameData.battle.lastUpdate = now;
        
        // Move student based on keys OR mobile direction
        const speed = 5;
        
        if (gameData.battle.moveDirection) {
            // Mobile 8-direction movement
            gameData.battle.studentPosition.x += gameData.battle.moveDirection.x * speed;
            gameData.battle.studentPosition.y += gameData.battle.moveDirection.y * speed;
        } else {
            // Keyboard movement
            if (gameData.battle.keysPressed['w'] || gameData.battle.keysPressed['arrowup']) {
                gameData.battle.studentPosition.y -= speed;
            }
            if (gameData.battle.keysPressed['s'] || gameData.battle.keysPressed['arrowdown']) {
                gameData.battle.studentPosition.y += speed;
            }
            if (gameData.battle.keysPressed['a'] || gameData.battle.keysPressed['arrowleft']) {
                gameData.battle.studentPosition.x -= speed;
            }
            if (gameData.battle.keysPressed['d'] || gameData.battle.keysPressed['arrowright']) {
                gameData.battle.studentPosition.x += speed;
            }
        }
        
        // Keep student in bounds
        const arena = document.getElementById('battle-arena');
        if (arena) {
            const arenaRect = arena.getBoundingClientRect();
            
            gameData.battle.studentPosition.x = Math.max(0, 
                Math.min(arenaRect.width - (window.innerWidth <= 768 ? 60 : 88), gameData.battle.studentPosition.x));
            gameData.battle.studentPosition.y = Math.max(0, 
                Math.min(arenaRect.height - (window.innerWidth <= 768 ? 60 : 88), gameData.battle.studentPosition.y));
        }
        
        // Update active effects (parent ghosts)
        gameData.battle.activeEffects.forEach((effect, index) => {
            if (effect.element.classList.contains('parent-ghost')) {
                // Move ghost toward student
                const dx = gameData.battle.studentPosition.x - effect.x;
                const dy = gameData.battle.studentPosition.y - effect.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    effect.x += (dx / distance) * effect.speed;
                    effect.y += (dy / distance) * effect.speed;
                    effect.element.style.left = effect.x + 'px';
                    effect.element.style.top = effect.y + 'px';
                    
                    // Check collision with student
                    if (distance < 44) { // Student radius
                        gameData.battle.studentHealth -= 5;
                        updateHealthBars();
                        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
                            playSoundEffect('Alert', 0.4);
                        }
                        
                        // Remove ghost on hit
                        effect.element.remove();
                        gameData.battle.activeEffects.splice(index, 1);
                    }
                }
            }
        });
        
        // AI teacher movement
        moveTeacherAI();
        
        // Update teacher sprite animation
        updateTeacherSpriteAnimation();
        
        // Update positions
        updatePositions();
        
        // Update projectiles
        updateProjectiles();
        
        // Check collisions
        checkCollisions();
    }

    // Update teacher sprite animation
    function updateTeacherSpriteAnimation() {
        if (!gameData.currentTeacher || !gameData.currentTeacher.useSprite) {
            return;
        }
        
        // Track if teacher is moving
        const oldX = gameData.battle.teacherPosition.x;
        const oldY = gameData.battle.teacherPosition.y;
        
        // AI teacher movement
        moveTeacherAI();
        
        // Check if teacher moved
        const moved = (gameData.battle.teacherPosition.x !== oldX || gameData.battle.teacherPosition.y !== oldY);
        gameData.battle.teacherWalking = moved;
        
        // Update sprite
        updateTeacherSprite();
    }

    // AI teacher movement
    function moveTeacherAI() {
        const speed = 2.5 + (gameData.battle.currentRound * 0.3);
        const dx = gameData.battle.studentPosition.x - gameData.battle.teacherPosition.x;
        const dy = gameData.battle.studentPosition.y - gameData.battle.teacherPosition.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance > 100) {
            gameData.battle.teacherPosition.x += (dx / distance) * speed;
            gameData.battle.teacherPosition.y += (dy / distance) * speed;
        }
        
        // Random attack (if intro isn't playing)
        if (Math.random() < 0.01 && distance < 250 && !gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            teacherAttack();
        }
    }

    // Update positions
    function updatePositions() {
        const studentSquare = document.getElementById('student-square');
        const teacherSquare = document.getElementById('teacher-square');
        const teacherSprite = document.getElementById('teacher-sprite');
        
        if (studentSquare) {
            studentSquare.style.left = gameData.battle.studentPosition.x + 'px';
            studentSquare.style.top = gameData.battle.studentPosition.y + 'px';
        }
        
        if (teacherSquare) {
            teacherSquare.style.left = gameData.battle.teacherPosition.x + 'px';
            teacherSquare.style.top = gameData.battle.teacherPosition.y + 'px';
        }
        
        // Teacher sprite position is updated in updateTeacherSprite()
    }

    // Shoot projectile
    function shootProjectile() {
        if (!gameData.battle.gameActive || gameData.battle.isSpawning || gameData.battle.showPopup || gameData.battle.playingVideo) return;
        
        // Calculate direction towards teacher
        const dx = gameData.battle.teacherPosition.x - gameData.battle.studentPosition.x;
        const dy = gameData.battle.teacherPosition.y - gameData.battle.studentPosition.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        const velocityX = (dx / distance) * 8;
        const velocityY = (dy / distance) * 8;
        
        createProjectile(
            gameData.battle.studentPosition.x + (window.innerWidth <= 768 ? 30 : 44),
            gameData.battle.studentPosition.y + (window.innerWidth <= 768 ? 30 : 44),
            velocityX, velocityY, 'student', 10, false
        );
        
        // Only play sound if intro isn't playing
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('Alert', 0.3);
        }
    }

    // Special attack with cooldown
    function specialAttack() {
        if (!gameData.battle.gameActive || gameData.battle.isSpawning || gameData.battle.showPopup || !gameData.battle.specialAttackReady || gameData.battle.playingVideo) return;
        
        // Create 5 spread projectiles
        for (let i = -2; i <= 2; i++) {
            const angle = i * 0.4;
            createProjectile(
                gameData.battle.studentPosition.x + (window.innerWidth <= 768 ? 30 : 44),
                gameData.battle.studentPosition.y + (window.innerWidth <= 768 ? 30 : 44),
                Math.cos(angle) * 10, Math.sin(angle) * 10, 'student', 20, true
            );
        }
        
        // Start cooldown
        gameData.battle.specialAttackReady = false;
        gameData.battle.specialCooldown = gameData.battle.specialMaxCooldown;
        
        updateSpecialUI();
        updateMobileSpecialUI();
        
        // Only play sound if intro isn't playing
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('Heavenly Sound', 0.5);
        }
    }

    // Teacher attack
    function teacherAttack() {
        if (!gameData.battle.gameActive || gameData.battle.isSpawning || gameData.battle.showPopup || gameData.battle.playingVideo) return;
        
        const dx = gameData.battle.studentPosition.x - gameData.battle.teacherPosition.x;
        const dy = gameData.battle.studentPosition.y - gameData.battle.teacherPosition.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        const velocityX = (dx / distance) * 6;
        const velocityY = (dy / distance) * 6;
        
        createProjectile(
            gameData.battle.teacherPosition.x + (window.innerWidth <= 768 ? 28 : 35),
            gameData.battle.teacherPosition.y + (window.innerWidth <= 768 ? 28 : 35),
            velocityX, velocityY, 'teacher', 8, false
        );
        
        // Only play sound if intro isn't playing
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playSoundEffect('Alert', 0.2, true);
        }
    }

    // Create projectile
    function createProjectile(x, y, vx, vy, type, damage, isSpecial) {
        const arena = document.getElementById('battle-arena');
        const projectile = document.createElement('div');
        
        if (isSpecial) {
            projectile.className = 'projectile special-projectile';
        } else {
            projectile.className = `projectile ${type}-projectile`;
        }
        
        projectile.style.left = x + 'px';
        projectile.style.top = y + 'px';
        
        arena.appendChild(projectile);
        
        gameData.battle.projectiles.push({
            element: projectile,
            x: x,
            y: y,
            vx: vx,
            vy: vy,
            type: type,
            damage: damage,
            isSpecial: isSpecial,
            active: true
        });
    }

    // Update projectiles
    function updateProjectiles() {
        const arena = document.getElementById('battle-arena');
        if (!arena) return;
        
        const arenaRect = arena.getBoundingClientRect();
        
        for (let i = gameData.battle.projectiles.length - 1; i >= 0; i--) {
            const proj = gameData.battle.projectiles[i];
            if (!proj.active) continue;
            
            // Update position
            proj.x += proj.vx;
            proj.y += proj.vy;
            
            proj.element.style.left = proj.x + 'px';
            proj.element.style.top = proj.y + 'px';
            
            // Check collision
            const targetPos = proj.type === 'student' ? 
                gameData.battle.teacherPosition : gameData.battle.studentPosition;
            
            const targetRadius = proj.type === 'student' ? (window.innerWidth <= 768 ? 28 : 35) : (window.innerWidth <= 768 ? 30 : 44);
            const targetCenter = proj.type === 'student' ? (window.innerWidth <= 768 ? 28 : 35) : (window.innerWidth <= 768 ? 30 : 44);
            
            const dx = proj.x - (targetPos.x + targetCenter);
            const dy = proj.y - (targetPos.y + targetCenter);
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < targetRadius) {
                // Hit!
                if (proj.type === 'student') {
                    gameData.battle.teacherHealth -= proj.damage;
                    gameData.battle.totalScore += proj.damage * 15;
                    
                    // Show hit effect on teacher with sprite
                    if (gameData.currentTeacher.useSprite && gameData.currentTeacher.sprite) {
                        gameData.currentTeacher.sprite.currentSprite = 'hit';
                        setTimeout(() => {
                            gameData.currentTeacher.sprite.currentSprite = 'idle';
                        }, 200);
                    }
                } else {
                    gameData.battle.studentHealth -= proj.damage;
                }
                
                // Show damage number
                showDamageNumber(targetPos.x + targetCenter, 
                               targetPos.y + targetCenter, 
                               proj.damage);
                
                // Remove projectile
                proj.element.remove();
                proj.active = false;
                gameData.battle.projectiles.splice(i, 1);
                
                // Play hit sound (only if intro isn't playing)
                if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
                    playSoundEffect('Alert', 0.4, true);
                }
                
                updateHealthBars();
                updateBattleUI();
                continue;
            }
            
            // Remove if out of bounds
            if (proj.x < -50 || proj.x > arenaRect.width + 50 || 
                proj.y < -50 || proj.y > arenaRect.height + 50) {
                proj.element.remove();
                proj.active = false;
                gameData.battle.projectiles.splice(i, 1);
            }
        }
    }

    // Show damage number
    function showDamageNumber(x, y, damage) {
        const arena = document.getElementById('battle-arena');
        const damageText = document.createElement('div');
        damageText.className = 'damage-text';
        damageText.textContent = `-${damage}`;
        damageText.style.left = x + 'px';
        damageText.style.top = y + 'px';
        
        arena.appendChild(damageText);
        
        // Auto-remove
        setTimeout(() => {
            if (damageText.parentNode) {
                damageText.parentNode.removeChild(damageText);
            }
        }, 1000);
    }

    // Check collisions
    function checkCollisions() {
        const studentRadius = window.innerWidth <= 768 ? 30 : 44;
        const teacherRadius = window.innerWidth <= 768 ? 28 : 35;
        
        const dx = gameData.battle.studentPosition.x - gameData.battle.teacherPosition.x;
        const dy = gameData.battle.studentPosition.y - gameData.battle.teacherPosition.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // Collision detection
        if (distance < (studentRadius + teacherRadius)) {
            // Push apart
            const push = 5;
            gameData.battle.studentPosition.x += (dx / distance) * push;
            gameData.battle.studentPosition.y += (dy / distance) * push;
            gameData.battle.teacherPosition.x -= (dx / distance) * push;
            gameData.battle.teacherPosition.y -= (dx / distance) * push;
            
            // Small damage on collision
            gameData.battle.studentHealth -= 1;
            gameData.battle.teacherHealth -= 2;
            updateHealthBars();
            
            // Play collision sound (only if intro isn't playing)
            if (Math.random() < 0.3 && !gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
                playSoundEffect('Burp', 0.3, true);
            }
        }
    }

    // Teacher defeated
    function teacherDefeated() {
        gameData.battle.isSpawning = true;
        gameData.battle.gameActive = false;
        gameData.battle.teachersDefeated++;
        gameData.battle.totalScore += 1000;
        gameData.battle.currentRound++;
        
        // Play teacher death sound (only if intro isn't playing)
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            playTeacherDeathSound(gameData.currentTeacher.name);
        }
        
        // Check if all teachers are defeated
        if (gameData.teacherOrder.length === 0) {
            // All teachers defeated - show victory screen
            setTimeout(() => {
                showVictoryScreen();
            }, 1000);
            return;
        }
        
        // Show spawn screen
        const spawnScreen = document.getElementById('next-teacher-spawn');
        spawnScreen.style.display = 'flex';
        
        // Clear projectiles and effects
        gameData.battle.projectiles.forEach(proj => proj.element.remove());
        gameData.battle.projectiles = [];
        gameData.battle.activeEffects.forEach(effect => effect.element.remove());
        gameData.battle.activeEffects = [];
        
        // Start spawn timer
        let timer = 3;
        document.getElementById('spawn-timer').textContent = timer;
        
        const countdown = setInterval(() => {
            timer--;
            document.getElementById('spawn-timer').textContent = timer;
            
            if (timer <= 0) {
                clearInterval(countdown);
                spawnScreen.style.display = 'none';
                
                // Spawn new teacher
                selectNextTeacher();
            }
        }, 1000);
    }

    // End battle
    function endBattle(winner) {
        gameData.battle.gameActive = false;
        
        // Calculate battle time
        const battleTime = Math.floor((Date.now() - gameData.battle.startTime) / 1000);
        
        // Update results
        document.getElementById('result-title').textContent = 
            winner === 'student' ? 'VICTORY!' : 'GAME OVER';
        
        document.getElementById('winner-text').textContent = 
            winner === 'student' ? 'Student Wins!' : 'Teacher Wins!';
        
        document.getElementById('winner-name').textContent = winner === 'student' ? 
            gameData.selectedStudent.name : gameData.currentTeacher.name;
        
        document.getElementById('teachers-defeated-result').textContent = gameData.battle.teachersDefeated;
        document.getElementById('total-score').textContent = gameData.battle.totalScore.toLocaleString();
        document.getElementById('battle-time').textContent = battleTime;
        document.getElementById('round-result').textContent = gameData.battle.currentRound;
        
        // Update summary
        const summary = winner === 'student' ? 
            `${gameData.selectedStudent.name} defeated ${gameData.battle.teachersDefeated} teachers in ${battleTime} seconds!` :
            `${gameData.currentTeacher.name} won in round ${gameData.battle.currentRound}.`;
        
        document.getElementById('battle-summary').textContent = summary;
        
        // Play end game sound (only if intro isn't playing)
        if (!gameData.sounds.currentlyPlaying.has('RNintro') && !gameData.sounds.currentlyPlaying.has('ModiIntro')) {
            if (winner === 'student') {
                playSoundEffect('Heavenly Sound', 0.8);
                playSoundEffect('Crowd Laughing', 0.5);
            } else {
                playStudentDeathSound(); // Play GTA 5 Wasted when student dies
            }
        }
        
        // Update high scores if student won and score is high enough
        if (winner === 'student') {
            const newScore = {
                name: gameData.selectedStudent.name,
                score: gameData.battle.totalScore,
                teachersDefeated: gameData.battle.teachersDefeated,
                round: gameData.battle.currentRound
            };
            
            // Add new score
            gameData.highScores.push(newScore);
            
            // Sort and keep top 5
            gameData.highScores.sort((a, b) => b.score - a.score);
            gameData.highScores = gameData.highScores.slice(0, 5);
            loadHighScores();
        }
        
        // Show results screen
        showScreen('results-screen');
    }

    // Play again from victory screen
    function playAgain() {
        document.getElementById('victory-screen').style.display = 'none';
        showScreen('battle-screen');
        setTimeout(() => {
            initializeBattle();
        }, 100);
        playSoundEffect('Alert', 0.3);
    }

    // Rematch
    function rematch() {
        showScreen('battle-screen');
        setTimeout(() => {
            initializeBattle();
        }, 100);
        playSoundEffect('Alert', 0.3);
    }
</script>
</body>
</html>
